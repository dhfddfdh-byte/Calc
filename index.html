<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adopt Me Trade Calculator</title>
    <!-- Feature: Chart.js for History Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0b1120;
            --panel: #161e2e;
            --card: #1e293b;
            --border: #334155;
            --text: #f1f5f9;
            --subtext: #94a3b8;
            --accent: #6366f1;
            --frost: #38bdf8;
            --win: #10b981;
            --lose: #ef4444;
            --trap: #f59e0b;
            --demand-color: #fbbf24;
            --rarity-legendary: #ff9800;
            --rarity-ultra: #f06292;
            --rarity-rare: #4fc3f7;
            --rarity-uncommon: #81c784;
            --rarity-common: #bdbdbd;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .loading-spinner {
            width: 60px; height: 60px; border: 4px solid var(--border);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; font-size: 1.2em; color: var(--subtext); }
        .nav-bar {
            width: 100%;
            max-width: 1150px;
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
            gap: 10px;
        }
        .nav-btn {
            background: var(--panel);
            border: 1.5px solid var(--border);
            color: white;
            padding: 12px 24px;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 800;
            transition: 0.2s;
        }
        .nav-btn:hover {
            border-color: var(--accent);
            background: var(--card);
        }
        .container {
    width: 100%; max-width: 1150px; display: flex; gap: 25px;
    flex-direction: row; margin-top: 40px;
    margin-bottom: 280px; 
}
        .trade-panel {
            flex: 1; background: var(--panel); border-radius: 24px;
            border: 1.5px solid var(--border); min-width: 340px; min-height: 520px;
        }
        .p-header {
            padding: 20px 25px; display: flex; justify-content: space-between;
            align-items: flex-start; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .p-title { font-weight: 800; font-size: 1.25em; color: white; }
        
        .p-dem { 
            color: var(--demand-color); 
            font-size: 0.95em; 
            font-weight: 800; 
            margin-top: 4px; 
            display: block; 
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.2);
        }
        .p-total { font-size: 1.6em; font-weight: 900; color: white; }
        .grid {
            padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr));
            gap: 15px;
        }
        .card {
            background: var(--card); border-radius: 14px; padding: 12px 8px;
            display: flex; flex-direction: column; align-items: center; position: relative;
            border: 1.5px solid transparent; transition: all 0.2s;
        }
        .card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .card-img-container {
            width: 65px; height: 65px; display: flex; align-items: center;
            justify-content: center; margin-bottom: 5px; cursor: copy;
        }
        .card-img-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .card-name {
            font-size: 0.7em; font-weight: 800; text-align: center; min-height: 2.4em;
            line-height: 1.2; color: #cbd5e1; overflow: visible; word-wrap: break-word;
            max-width: 100%;
        }
        .card-val { font-size: 0.95em; font-weight: 950; color: var(--frost); margin: 6px 0 2px 0; }
        .card-demand {
            font-size: 0.8em; font-weight: 800; color: var(--demand-color); margin-bottom: 4px;
        }
        .del {
            position: absolute; top: -6px; right: -6px; width: 22px; height: 22px;
            background: #ef4444; color: white; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 12px;
            cursor: pointer; z-index: 10; border: 2px solid var(--panel);
        }
        .toggles { display: flex; gap: 3px; }
        .t-btn {
            width: 20px; height: 20px; background: #0f172a; border-radius: 4px;
            font-size: 0.65em; font-weight: 900; color: #475569; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .t-btn.active { background: #3b82f6; color: white; }
        .card-stack-badge {
            position: absolute; top: 5px; left: 5px; background: var(--accent);
            color: white; font-size: 0.75em; font-weight: 900; padding: 2px 8px;
            border-radius: 6px; z-index: 11; border: 1px solid var(--panel);
        }
        .plus {
            border: 2px dashed var(--border); border-radius: 14px; height: 150px;
            display: flex; align-items: center; justify-content: center; font-size: 2.5em;
            color: var(--border); cursor: pointer; transition: all 0.2s;
        }
        .plus:hover { border-color: var(--accent); color: var(--accent); }
        .verdict-box {
            position: fixed; bottom: 30px; background: var(--panel); width: 90%;
            max-width: 520px; padding: clamp(15px, 2.5vw, 25px); border-radius: 30px;
            border: 1px solid var(--border); text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.7); z-index: 1000;
            left: 50%; transform: translateX(-50%);
        }
        .gauge-wrapper {
            width: 100%; height: 24px; background: #0f172a; border-radius: 12px; margin-bottom: 15px; position: relative; border: 1px solid var(--border); overflow: hidden;
        }
        
        .gauge-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ef4444 0%, #facc15 50%, #10b981 100%); }
        .gauge-bar.trap-active { background: repeating-linear-gradient(45deg, #b45309, #b45309 10px, #f59e0b 10px, #f59e0b 20px); }
        .gauge-needle {
            position: absolute; top: -2px; left: 50%; width: 4px; height: 28px; background: white; border: 1px solid black; transform: translateX(-50%); transition: left 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 2px; z-index: 2; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .v-text {
            font-size: clamp(2em, 8vw, 3.5em); font-weight: 950; line-height: 1; margin-bottom: 8px; letter-spacing: -2px;
        }
        .v-diff { font-weight: 800; font-size: clamp(0.9em, 3vw, 1.2em); margin-bottom: 5px; color: white; }
        .v-sub { color: var(--subtext); font-style: italic; font-size: clamp(0.75em, 2vw, 0.95em); margin-bottom: 18px; line-height: 1.4; padding: 0 10px; }
        .switches { display: inline-flex; background: #0f172a; padding: 5px; border-radius: 25px; align-items: center; gap: 10px; }
        .sw-btn { background: transparent; border: none; color: var(--subtext); padding: 8px 24px; border-radius: 20px; cursor: pointer; font-weight: 800; }
        .sw-btn.active { background: var(--accent); color: white; }
        .save-trade-btn { background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 700; font-size: 0.8em; margin-left: 5px; }
        .save-trade-btn:hover { background: var(--accent); }
        #graphOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; z-index: 5500; }
        .graph-container { width: 95%; max-width: 800px; background: #1a2333; border-radius: 28px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .graph-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #111827; }
        .graph-body { padding: 30px; background: #0f172a; height: 400px; }
        #infoOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.97); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 6000; }
        .info-container { width: 95%; max-width: 600px; background: #1a2333; border-radius: 28px; border: 1px solid var(--border); box-shadow: 0 30px 70px rgba(0,0,0,0.8); overflow: hidden; }
        .info-header { padding: 20px; background: #111827; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .info-body { padding: 30px; overflow-y: auto; max-height: 70vh; color: #cbd5e1; line-height: 1.6; }
        .info-section { margin-bottom: 25px; }
        .info-section h4 { color: var(--accent); margin-bottom: 10px; font-weight: 900; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .info-label { font-weight: 700; color: white; }
        .info-val { font-size: 0.9em; }
        .inv-suggest-container { padding: 15px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(99, 102, 241, 0.03); border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; }
        .inv-suggest-title { font-size: 0.8em; font-weight: 900; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .suggest-pill-row { display: flex; flex-direction: column; gap: 8px; }
        .suggest-pill {
            background: var(--card); border: 1px solid var(--border); padding: 8px 12px; border-radius: 12px; font-size: 0.75em; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .suggest-pill:hover { border-color: var(--accent); background: #262c3d; }
        .suggest-items-text { font-weight: 700; color: #cbd5e1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; }
        .suggest-val-text { font-weight: 900; color: var(--win); }
        .inv-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .inv-container { width: 95%; max-width: 1100px; background: #1a2333; border-radius: 28px; border: 1px solid var(--border); display: flex; flex-direction: column; max-height: 85vh; overflow: hidden; }
        .inv-header { padding: 25px; border-bottom: 1.5px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #111827; }
        .inv-body { display: flex; flex: 1; overflow: hidden; }
        .inv-list { flex: 1.5; padding: 25px; overflow-y: auto; border-right: 1.5px solid var(--border); }
        .inv-stats { flex: 1.2; padding: 30px; background: #0f172a; overflow-y: auto; }
        .stat-card { background: var(--panel); padding: 20px; border-radius: 18px; border: 1px solid var(--border); margin-bottom: 20px; }
        .stat-label { font-size: 0.85em; color: var(--subtext); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .stat-value { font-size: 2em; font-weight: 950; color: white; margin-top: 5px; }
        .milestone-container { background: #161e2e; padding: 15px; border-radius: 15px; border: 1px solid var(--border); margin-top: 15px; }
        .milestone-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; opacity: 0.4; transition: 0.3s; }
        .milestone-row.active { opacity: 1; color: var(--frost); font-weight: 800; }
        .milestone-check { width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .milestone-row.active .milestone-check { border-color: var(--win); background: var(--win); color: white; }
        .ai-box { background: rgba(99, 102, 241, 0.05); border: 1.5px solid var(--accent); border-radius: 20px; padding: 20px; margin-top: 10px; }
        .ai-title { display: flex; align-items: center; justify-content: space-between; color: var(--accent); font-weight: 900; font-size: 1.1em; margin-bottom: 15px; }
        .ai-summary { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px dashed var(--accent); font-size: 0.9em; line-height: 1.4; color: white; }
        .ai-suggestion { background: #161e2e; padding: 15px; border-radius: 12px; border-left: 4px solid var(--accent); margin-bottom: 12px; font-size: 0.95em; line-height: 1.4; }
        .ai-item-tag { display: inline-block; background: var(--accent); color: white; padding: 2px 8px; border-radius: 6px; font-weight: 800; font-size: 0.85em; margin: 2px; }
        
        .ai-stats-row { display: flex; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #334155; }
        .ai-stat-pill { font-size: 0.75em; font-weight: 900; padding: 3px 8px; border-radius: 5px; }
        .pill-win { background: rgba(16, 185, 129, 0.15); color: var(--win); }
        .pill-dem { background: rgba(251, 191, 36, 0.15); color: var(--demand-color); }
        .ai-refresh-btn { background: var(--accent); color: white; border: none; padding: 5px 12px; border-radius: 8px; font-size: 0.7em; font-weight: 900; cursor: pointer; transition: 0.2s; }
        .ai-refresh-btn:hover { opacity: 0.8; transform: rotate(15deg); }
        .ai-toggle-group { display: flex; background: #0f172a; padding: 4px; border-radius: 10px; margin-bottom: 15px; gap: 4px; }
        .ai-tog { flex: 1; text-align: center; font-size: 0.7em; font-weight: 900; padding: 8px; border-radius: 7px; cursor: pointer; color: var(--subtext); transition: 0.2s; }
        .ai-tog.active { background: var(--accent); color: white; }
        .search-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; z-index: 4000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .search-overlay.open { opacity: 1; pointer-events: auto; }
        .search-container { width: 95%; max-width: 900px; background: #1a2333; border-radius: 28px; border: 1px solid var(--border); display: flex; flex-direction: column; max-height: 85vh; box-shadow: 0 25px 60px rgba(0,0,0,0.6); overflow: hidden; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .search-overlay.open .search-container { transform: scale(1); }
        .search-header { padding: 20px 25px; display: flex; gap: 12px; align-items: center; background: #111827; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
        .search-input-wrapper { flex: 2; position: relative; display: flex; align-items: center; min-width: 200px; }
        #mainSearch { width: 100%; padding: 14px 15px 14px 45px; background: #262c3d; border: 1px solid #334155; border-radius: 35px; color: white; font-size: 1.1em; outline: none; }
        #sortSelect, #rarityFilter { flex: 1; padding: 14px 15px; background: #262c3d; border: 1px solid #334155; border-radius: 35px; color: #94a3b8; font-size: 0.95em; font-weight: 600; outline: none; cursor: pointer; min-width: 150px; }
        #sortSelect:hover, #rarityFilter:hover { border-color: var(--accent); color: white; }
        .search-icon-fixed { position: absolute; left: 18px; font-size: 1.2em; }
        .close-modal-btn { width: 45px; height: 45px; background: #262c3d; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #94a3b8; font-size: 1.4em; }
        .close-modal-btn:hover { background: #ef4444; color: white; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; padding: 25px; overflow-y: auto; background: #161e2e; scroll-behavior: smooth; }
        .search-item-card { background: #262c3d; border-radius: 18px; padding: 15px 10px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.2s; border: 1.5px solid transparent; }
        .search-item-card:hover { background: #334155; transform: translateY(-4px); border-color: var(--accent); }
        .search-item-card.added { border-color: var(--win) !important; background: rgba(16, 185, 129, 0.1); }
        .search-item-name { font-size: 0.75em; font-weight: 800; color: #94a3b8; text-align: center; margin-bottom: 10px; min-height: 2.5em; overflow: visible; word-wrap: break-word; max-width: 100%; }
        .search-item-img { width: 85px; height: 85px; object-fit: contain; margin-bottom: 10px; }
        .search-item-val { font-weight: 900; font-size: 1.2em; color: white; }
        .search-item-demand { font-size: 0.9em; font-weight: 800; color: var(--demand-color); margin-top: 2px; text-shadow: 0 0 5px rgba(251, 191, 36, 0.3); }
        .results-grid::-webkit-scrollbar { width: 10px; }
        .results-grid::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; border: 2px solid #161e2e; }
        .similar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 5000; }
        .similar-container { width: 90%; max-width: 600px; background: #1a2333; border-radius: 20px; border: 1px solid var(--border); padding: 20px; max-height: 70vh; overflow-y: auto; display: flex; flex-direction: column; }
        .similar-item { display: flex; align-items: center; gap: 15px; background: var(--card); padding: 12px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 1.5px solid transparent; transition: 0.2s; }
        .similar-item:hover { border-color: var(--accent); background: #334155; }
        .similar-item.selected { border-color: var(--win); background: rgba(16, 185, 129, 0.05); }
        
        .ai-count-control { margin-bottom: 15px; display: flex; flex-direction: column; gap: 5px; }
        .ai-count-control label { font-size: 0.75em; color: var(--subtext); font-weight: 700; }
        .ai-count-control input { cursor: pointer; accent-color: var(--accent); }
        .history-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; z-index: 4500; }
        .history-container { width: 95%; max-width: 600px; background: #1a2333; border-radius: 20px; border: 1px solid var(--border); max-height: 80vh; display: flex; flex-direction: column; }
        .history-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .history-list { padding: 20px; overflow-y: auto; }
        .history-item { background: var(--panel); border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .history-item:hover { background: var(--card); border-color: var(--accent); }
        .history-time { font-size: 0.7em; color: var(--subtext); margin-bottom: 5px; }
        .history-details { display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 0.9em; }
        .dream-progress-bg { width: 100%; height: 10px; background: #0f172a; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .dream-progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s ease; }
        .dream-active-badge { background: var(--accent); color: white; padding: 5px 10px; border-radius: 8px; font-size: 0.8em; font-weight: 800; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .analytics-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; z-index: 4600; }
        .analytics-container { width: 95%; max-width: 700px; background: #1a2333; border-radius: 28px; border: 1px solid var(--border); max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; }
        .analytics-body { padding: 30px; overflow-y: auto; }
        .analytics-section { margin-bottom: 25px; }
        .analytics-section h4 { color: var(--accent); margin-bottom: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9em; }
        .bar-row { display: flex; align-items: center; margin-bottom: 12px; }
        .bar-label { width: 100px; font-size: 0.8em; font-weight: 700; color: #cbd5e1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bar-track { flex: 1; height: 10px; background: #0f172a; border-radius: 5px; margin: 0 15px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 5px; transition: width 0.5s ease; }
        .bar-stat { width: 60px; text-align: right; font-size: 0.8em; font-weight: 800; color: white; }
        .qty-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 6000; }
        .qty-modal { background: #1a2333; border: 1px solid var(--border); padding: 25px; border-radius: 20px; width: 300px; text-align: center; }
        .qty-modal h3 { color: white; margin-bottom: 20px; font-size: 1.1em; }
        .qty-input { background: #0f172a; border: 1px solid var(--border); color: white; font-size: 1.5em; padding: 10px; width: 100%; border-radius: 10px; text-align: center; margin-bottom: 20px; outline: none; }
        .qty-input:focus { border-color: var(--accent); }
        .qty-actions { display: flex; gap: 10px; justify-content: center; }
    
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* ===== NEW FEATURE STYLES ===== */
        .verdict-extras {
            position: fixed;
            left: 18px;
            bottom: 30px;
            width: 220px;
            display: flex;
            flex-direction: column;
            gap: 7px;
            z-index: 999;
            pointer-events: none;
        }
        .verdict-extras > * { pointer-events: auto; }
        @media screen and (max-width: 900px) {
            .verdict-extras { display: none; }
        }
        .trade-type-tag { font-size: 0.75em; font-weight: 900; padding: 4px 14px; border-radius: 20px; display: inline-block; letter-spacing: 0.5px; }
        .tag-downgrade { background: rgba(239,68,68,0.18); color: #fca5a5; border: 1px solid rgba(239,68,68,0.4); }
        .tag-penalty { background: rgba(245,158,11,0.18); color: #fcd34d; border: 1.5px solid rgba(245,158,11,0.5); }
        .tag-played { background: rgba(239,68,68,0.22); color: #f87171; border: 2px solid #ef4444; font-size: 0.8em; font-weight: 900; padding: 5px 14px; border-radius: 20px; animation: pulse 2s infinite; }
        .speed-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; font-size: 0.75em; font-weight: 900; }
        .speed-pill { padding: 3px 10px; border-radius: 12px; }
        .speed-fast { background: rgba(16,185,129,0.15); color: #34d399; }
        .speed-mod  { background: rgba(251,191,36,0.15);  color: #fbbf24; }
        .speed-slow { background: rgba(239,68,68,0.15);   color: #f87171; }
        .flip-row { font-size: 0.78em; font-weight: 800; color: var(--subtext); }
        .flip-high { color: #34d399; }
        .flip-med  { color: #fbbf24; }
        .flip-low  { color: #f87171; }
        /* Trending search section */
        .trending-section { padding: 12px 25px 0; border-bottom: 1px solid var(--border); background: rgba(99,102,241,0.04); }
        .trending-title { font-size: 0.7em; font-weight: 900; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .trending-pills { display: flex; gap: 7px; flex-wrap: wrap; margin-bottom: 10px; }
        .trending-pill { background: rgba(99,102,241,0.12); border: 1px solid rgba(99,102,241,0.35); border-radius: 20px; padding: 5px 11px; font-size: 0.7em; font-weight: 800; cursor: pointer; color: #c7d2fe; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
        .trending-pill:hover { background: rgba(99,102,241,0.28); border-color: var(--accent); }

        /* ========================================
           MOBILE RESPONSIVE STYLES
           ======================================== */
        
        /* Mobile Devices (phones) */
        @media screen and (max-width: 768px) {
    body {
        padding: 10px;
    }

    .nav-bar {
        flex-wrap: wrap;
        gap: 5px;
    }

    .nav-btn {
        padding: 8px 12px;
        font-size: 0.85em;
    }

    .container {
        margin-top: 20px;
        margin-bottom: 200px;
        gap: 15px;
        flex-direction: row;
    }
        .trade-panel {
    min-width: 340px;
    flex: 1;
}

        .grid {
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            padding: 15px;
        }

        .card {
            padding: 8px 6px;
        }

        .card-img-container {
            width: 50px;
            height: 50px;
        }

        .card-name {
            font-size: 0.65em;
        }

        .card-val {
            font-size: 0.85em;
        }

        .verdict-box {
            bottom: 10px;
            padding: 15px;
            max-width: 95%;
        }

        .v-text {
            font-size: 2em;
        }

        .switches {
            flex-wrap: wrap;
            gap: 5px;
        }

        .sw-btn {
            padding: 6px 16px;
            font-size: 0.85em;
        }

        .save-trade-btn {
            padding: 6px 12px;
            font-size: 0.75em;
            margin-left: 0;
            margin-top: 5px;
        }

        /* Search Modal Mobile */
        .search-container {
            max-width: 100%;
            max-height: 95vh;
        }

        .search-header {
            flex-direction: column;
            gap: 8px;
        }

        .search-input-wrapper {
            width: 100%;
            min-width: 100%;
        }

        #sortSelect, #rarityFilter {
            width: 100%;
            min-width: 100%;
        }

        .results-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 15px;
        }

        .search-item-card {
            padding: 10px 8px;
        }

        .search-item-img {
            width: 60px;
            height: 60px;
        }

        /* Inventory Mobile */
        .inv-container {
            max-width: 100%;
            max-height: 95vh;
        }

        .inv-header {
            flex-direction: column;
            gap: 10px;
            padding: 15px;
        }

        .inv-header > div {
            flex-direction: column;
            width: 100%;
            gap: 5px;
        }

        .inv-body {
            flex-direction: column;
        }

        .inv-list {
            border-right: none;
            border-bottom: 1.5px solid var(--border);
        }

        /* Info/Graph Modals Mobile */
        .graph-container,
        .info-container,
        .analytics-container,
        .history-container {
            max-width: 100%;
            max-height: 90vh;
        }

        .graph-body {
            height: 300px;
            padding: 15px;
        }

        .info-body {
            padding: 20px;
        }

        /* Quantity Modal Mobile */
        .qty-modal {
            width: 90%;
            padding: 20px;
        }

        /* AI Box Mobile */
        .ai-suggestion {
            font-size: 0.85em;
            padding: 12px;
        }

        .ai-toggle-group {
            flex-direction: column;
        }

        .ai-tog {
            padding: 10px;
            font-size: 0.8em;
        }
    }

    /* Tablet/Medium Screen Adjustments */
    @media screen and (min-width: 769px) and (max-width: 1024px) {
        .container {
            max-width: 100%;
        }

        .trade-panel {
            min-width: 45%;
        }

        .grid {
            grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
        }
    }

    /* Prevent zoom on input focus (iOS Safari) */
    @media screen and (max-width: 768px) {
        input, select, textarea {
            font-size: 16px !important;
        }
    }

    /* Touch-friendly interactions */
    @media (hover: none) and (pointer: coarse) {
        .card:hover {
            transform: none;
        }

        .card:active {
            transform: scale(0.98);
        }

        .nav-btn:hover {
            background: var(--panel);
        }

        .nav-btn:active {
            background: var(--card);
        }

        .plus:hover {
            border-color: var(--border);
            color: var(--border);
        }

        .plus:active {
            border-color: var(--accent);
            color: var(--accent);
        }
    }
</style>
</head>
<body>

    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading pet data from Google Sheets...</div>
    </div>

    <!-- Feature: History Graph Overlay -->
    <div id="graphOverlay">
        <div class="graph-container">
            <div class="graph-header">
                <h2 id="graphTitle" style="color: white; font-weight: 900;">PET HISTORY</h2>
                <button class="nav-btn" onclick="closeGraph()">Close</button>
            </div>
            <div class="graph-body">
                <canvas id="petChart"></canvas>
            </div>
            <div style="padding: 20px; background: #0f172a; border-top: 1px solid var(--border); color: #cbd5e1; line-height: 1.6;" id="trendAnalysis"></div>
        </div>
    </div>

    <!-- Feature: Information Overlay -->
    <div id="infoOverlay">
        <div class="info-container">
            <div class="info-header">
                <h3 style="color: white; font-weight: 950;">‚ÑπÔ∏è CALCULATOR GUIDE</h3>
                <button class="nav-btn" onclick="closeInfo()">Close</button>
            </div>
            <div class="info-body">
                <div class="info-section">
                    <h4>Mouse Keybinds</h4>
                    <div class="info-row"><span class="info-label">Right Click:</span><span class="info-val">Open Multi-Add (Quantity) Menu</span></div>
                    <div class="info-row"><span class="info-label">Shift + Right Click:</span><span class="info-val">View Demand & Value History Graph</span></div>
                    <div class="info-row"><span class="info-label">Double Click Image:</span><span class="info-val">Duplicate Pet Card</span></div>
                    <div class="info-row"><span class="info-label">Hover on Emojis:</span><span class="info-val">See exact amount of change in tooltip</span></div>
                </div>
                <div class="info-section">
                    <h4>Keyboard Keybinds</h4>
                    <div class="info-row"><span class="info-label">Ctrl + Z:</span><span class="info-val">Undo Last Change</span></div>
                </div>
                <div class="info-section">
                    <h4>Trend Emojis</h4>
                    <div class="info-row"><span class="info-label">üî• :</span><span class="info-val">Demand is increasing</span></div>
                    <div class="info-row"><span class="info-label">‚ùÑÔ∏è :</span><span class="info-val">Demand is decreasing</span></div>
                    <div class="info-row"><span class="info-label">üìà :</span><span class="info-val">Value is increasing</span></div>
                    <div class="info-row"><span class="info-label">üìâ :</span><span class="info-val">Value is decreasing</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn" onclick="openInfo()">‚ÑπÔ∏è Information</button>
        <button class="nav-btn" onclick="openHistory()">üìú History</button>
        <button class="nav-btn" onclick="openInventory()">üì¶ My Inventory</button>
    </div>

    <div class="analytics-overlay" id="analyticsOverlay">
        <div class="analytics-container">
            <div class="history-header">
                <h3 style="color: white; font-weight: 900;">INVENTORY PORTFOLIO</h3>
                <button class="nav-btn" style="padding: 5px 15px;" onclick="closeAnalytics()">Close</button>
            </div>
            <div class="analytics-body" id="analyticsBody"></div>
        </div>
    </div>

    <div class="qty-modal-overlay" id="qtyModal" onclick="closeQtyModal()">
        <div class="qty-modal" onclick="event.stopPropagation()">
            <h3 id="qtyTitle">How many?</h3>
            <input type="number" id="qtyInput" class="qty-input" min="1" max="18" value="1">
            <div class="qty-actions">
                <button class="nav-btn" onclick="confirmQty()">Add</button>
                <button class="nav-btn" style="background: #ef4444; border-color: #b91c1c;" onclick="closeQtyModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="history-overlay" id="historyOverlay">
        <div class="history-container">
            <div class="history-header">
                <h3 style="color: white;">Trade History (Last 10)</h3>
                <button class="nav-btn" style="padding: 5px 15px;" onclick="closeHistory()">Close</button>
            </div>
            <div class="history-list" id="historyList">
                <div style="text-align: center; color: var(--subtext);">No history yet. Calculate trades to save them!</div>
            </div>
        </div>
    </div>

    <div class="similar-overlay" id="similarOverlay" onclick="closeSimilarPopup()">
        <div class="similar-container" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="font-weight: 900; color: var(--accent);">Target Selection</h3>
                <button class="nav-btn" style="padding: 5px 15px; font-size: 0.75em;" onclick="closeSimilarPopup()">Confirm</button>
            </div>
            <div id="similarList"></div>
        </div>
    </div>

    <div class="inv-overlay" id="invOverlay">
        <div class="inv-container">
            <div class="inv-header">
                <div style="display:flex; gap:10px; align-items:center;">
                    <h2 style="font-weight: 900;">INVENTORY</h2>
                    <button class="nav-btn" style="padding: 6px 12px; font-size: 0.7em;" onclick="exportInv()">Export Data</button>
                    <button class="nav-btn" style="padding: 6px 12px; font-size: 0.7em;" onclick="importInv()">Import Data</button>
                    <button class="nav-btn" style="padding: 6px 12px; font-size: 0.7em; background: var(--accent); border-color: var(--accent);" onclick="openAnalytics()">View Portfolio</button>
                </div>
                <button class="nav-btn" onclick="closeInventory()">Close</button>
            </div>
            <div class="inv-body">
                <div class="inv-list">
                    <button class="nav-btn" style="width: 100%; margin-bottom: 20px;" onclick="openSearch('inv')">+ Add Item to Inventory</button>
                    <div class="grid" id="invGrid"></div>
                </div>
                <div class="inv-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total Normal Value</div>
                        <div class="stat-value" id="invTotalValue">0.00</div>
                        <button class="nav-btn" style="width: 100%; margin-top: 15px; padding: 8px; font-size: 0.75em;" onclick="findSimilarToTotal()">Find Global Value Matches</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Demand</div>
                        <div class="stat-value" id="invAvgDemand">0.0</div>
                    </div>

                    <div class="milestone-container">
                        <div style="font-size: 0.8em; font-weight: 900; color: var(--accent); margin-bottom: 10px;">TRADING MILESTONES</div>
                        <div class="milestone-row" id="mile-1"><div class="milestone-check">‚úì</div>Starter (1.0 Val)</div>
                        <div class="milestone-row" id="mile-2"><div class="milestone-check">‚úì</div>Apprentice (10.0 Val)</div>
                        <div class="milestone-row" id="mile-3"><div class="milestone-check">‚úì</div>Merchant (50.0 Val)</div>
                        <div class="milestone-row" id="mile-4"><div class="milestone-check">‚úì</div>Rich (100.0 Val)</div>
                        <div class="milestone-row" id="mile-5"><div class="milestone-check">‚úì</div>Master (155.0 Val)</div>
                    </div>
                    
                    <div class="ai-box">
                        <div class="ai-title">
                            ü§ñ AI Strategist
                            <button class="ai-refresh-btn" onclick="renderInventory()">Refresh ‚Üª</button>
                        </div>
                        
                        <div class="ai-toggle-group">
                            <div class="ai-tog active" id="aiTogNormal" onclick="setAiStrategy('normal')">Normal Mode</div>
                            <div class="ai-tog" id="aiTogVelocity" onclick="setAiStrategy('velocity')">Velocity Mode</div>
                        </div>

                        <div id="dreamPetContainer" style="margin-bottom: 15px;">
                            <button class="nav-btn" style="width: 100%; font-size: 0.8em; padding: 8px;" onclick="openSearch('dream')">‚òÖ Set Dream Pet</button>
                        </div>

                        <div class="ai-count-control">
                            <label>Strategy Count: <span id="strategyCountVal">10</span></label>
                            <input type="range" id="strategyCountSlider" min="1" max="10" value="10" oninput="updateStrategyCount(this.value)">
                        </div>

                        <div id="aiSuggestions">
                            <div class="ai-suggestion">Add pets to your inventory to generate AI-driven trade offers.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="search-overlay" id="searchOverlay" onclick="closeSearch()">
        <div class="search-container" onclick="event.stopPropagation()">
            <div class="search-header">
                <div class="search-input-wrapper">
                    <span class="search-icon-fixed">üîç</span>
                    <input type="text" id="mainSearch" placeholder="Search for a pet..." autocomplete="off">
                </div>
                
                <select id="rarityFilter" onchange="updateFilter()">
                    <option value="none">Rarity: None</option>
                    <option value="high tier">High Tier</option>
                    <option value="mid tier">Mid Tier</option>
                    <option value="classy">Classy</option>
                    <option value="randoms">Randoms</option>
                    <option value="default legs">Default Legs</option>
                    <option value="preppy">Preppy</option>
                    <option value="exotic">Exotic</option>
                    <option value="legendary">Legendary</option>
                    <option value="ultra-rare">Ultra-Rare</option>
                    <option value="rare">Rare</option>
                    <option value="uncommon">Uncommon</option>
                    <option value="common">Common</option>
                </select>

                <select id="sortSelect" onchange="updateFilter()">
                    <option value="default">Default</option>
                    <option value="valHigh">Value (High ‚Üí Low)</option>
                    <option value="valLow">Value (Low ‚Üí High)</option>
                    <option value="demHigh">Demand (High ‚Üí Low)</option>
                    <option value="demLow">Demand (Low ‚Üí High)</option>
                </select>
                <div class="close-modal-btn" onclick="closeSearch()">‚úï</div>
            </div>
            <div class="results-grid" id="searchResults"></div>
        </div>
    </div>

    <div class="container">
        <div class="trade-panel" id="panelA">
            <div class="p-header">
                <div>
                    <span class="p-title">You Give (<span id="cntA">0</span>)</span>
                    <span class="p-dem" id="demA">Avg Demand: 0.0</span>
                </div>
                <span class="p-total" id="totA">0.000</span>
            </div>
            <div class="grid" id="gridA"></div>
            <div class="inv-suggest-container" id="sideASuggestions" style="display: none;">
                <div class="inv-suggest-title">ü§ñ Smart Offer Suggestions</div>
                <div class="suggest-pill-row" id="suggestList"></div>
            </div>
        </div>

        <div class="trade-panel" id="panelB">
            <div class="p-header">
                <div>
                    <span class="p-title">They Give (<span id="cntB">0</span>)</span>
                    <span class="p-dem" id="demB">Avg Demand: 0.0</span>
                </div>
                <span class="p-total" id="totB">0.000</span>
            </div>
            <div class="grid" id="gridB"></div>
        </div>
    </div>

    <div class="verdict-box">
        <div class="gauge-wrapper">
            <div id="gaugeBar" class="gauge-bar"></div>
            <div id="gaugeNeedle" class="gauge-needle"></div>
        </div>
        
        <div id="verdict" class="v-text">--</div>
        <div id="vDiff" class="v-diff">Difference: 0.000 (0.0%)</div>
        <div id="vSub" class="v-sub">Add pets to calculate trade results</div>
        <div class="switches">
            <button class="sw-btn active" id="btnFrost" onclick="setMode('frost')">Frost</button>
            <button class="sw-btn" id="btnValue" onclick="setMode('value')">Value</button>
            <button class="save-trade-btn" onclick="logCurrentTrade()">Save to History</button>
        </div>
    </div>

   <script>
        // CRITICAL DATA VARIABLES DEFINED AT TOP
        const MASTER_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpYtDhy048sVlxFk5obx9I2uSBxu89gzCCpyttrzza85TsVAtL-JsX0id93Q7q7WcNXLVms4SgR8Jg/pub?gid=697881438&single=true&output=csv';
        const HISTORY_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpYtDhy048sVlxFk5obx9I2uSBxu89gzCCpyttrzza85TsVAtL-JsX0id93Q7q7WcNXLVms4SgR8Jg/pub?gid=1671406739&single=true&output=csv';
        
        let ALL_PETS = [];
        let HISTORY_DATA = []; 
        let state = { mode: 'frost', A: [], B: [], inv: [], target: 'A', aiMode: 'normal', strategyLimit: 10, aiTargetPets: [], dreamPet: null };
        let history = []; 
        let tradeLog = []; 
        let selectedPetForQty = null; 
        let searchState = { currentMatches: [], renderLimit: 50, sortMode: 'default', rarityFilter: 'none' };
        let petChart = null;
        // Essential Helper Functions
        function getRarityColor(rarity) {
            if (!rarity) return 'var(--rarity-common)';
            const r = rarity.toLowerCase();
            if (r.includes('legendary')) return 'var(--rarity-legendary)';
            if (r.includes('ultra')) return 'var(--rarity-ultra)';
            if (r.includes('rare')) return 'var(--rarity-rare)';
            if (r.includes('uncommon')) return 'var(--rarity-uncommon)';
            return 'var(--rarity-common)';
        }
        function getDemandColor(demand) {
            if (demand >= 7) return '#4caf50';
            if (demand >= 4) return '#ffeb3b';
            return '#f44336';
        }
        function getTrendIcons(p) {
    if (!p || (!p.vt && !p.dt)) return "";
    let html = "";
    try {
        let crashWarning = "";
        
        // DEBUG: Check if history data exists
        if (!Array.isArray(HISTORY_DATA) || HISTORY_DATA.length === 0) {
            console.log("‚ö†Ô∏è No history data loaded yet for", p.n);
        } else {
            try {
                // Case-insensitive name matching
                const petHistory = HISTORY_DATA.filter(row => 
                    row.name && p.n && 
                    row.name.toLowerCase().trim() === p.n.toLowerCase().trim()
                );
                console.log(`üìä ${p.n}: Found ${petHistory.length} history records`);
                
                if (petHistory.length >= 2) {
                    const currentData = petHistory[petHistory.length - 1];
                    const lookbackLimit = Math.min(10, petHistory.length);
                    const historicalData = petHistory.slice(-lookbackLimit);
                    
                    let maxDemand = Math.max(...historicalData.map(h => h.d));
                    let maxValue = Math.max(...historicalData.map(h => h.v));
                    
                    const demandDrop = maxDemand - currentData.d;
                    const valueDrop = maxValue - currentData.v;
                    
                    console.log(`${p.n} - Demand drop: ${demandDrop.toFixed(2)}, Value drop: ${valueDrop.toFixed(2)}`);
                    
                    let hasCrashed = false;
                    let crashType = "";
                    let crashAmount = 0;
                    
                    if (demandDrop > 0.3) {
                        hasCrashed = true;
                        crashType = "DEMAND";
                        crashAmount = demandDrop;
                    }
                    
                    if (valueDrop > 2.0) {
                        hasCrashed = true;
                        if (crashType) crashType += " & VALUE";
                        else crashType = "VALUE";
                        crashAmount = Math.max(crashAmount, valueDrop);
                    }
                    
                    if (hasCrashed) {
                        const isRecovering = petHistory.length >= 3 && 
                                           currentData.d > petHistory[petHistory.length - 2].d;
                        
                        console.log(`üö® ${p.n} CRASH DETECTED! Type: ${crashType}, Amount: ${crashAmount.toFixed(2)}, Recovering: ${isRecovering}`);
                        
                        if (isRecovering) {
                            crashWarning = `üö® MAJOR ${crashType} CRASH DETECTED! üö®\n`;
                            crashWarning += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                            crashWarning += `‚ö†Ô∏è This pet recently crashed in ${crashType.toLowerCase()}!\n`;
                            crashWarning += `üìâ Peak ‚Üí Current Drop: ${crashAmount.toFixed(2)}\n\n`;
                            crashWarning += `üìà RECOVERY IN PROGRESS:\n`;
                            crashWarning += `The pet has started rising again, but be cautious.\n`;
                            crashWarning += `A crash this large often signals market instability.\n`;
                            crashWarning += `Trade with EXTREME caution.\n\n`;
                        } else {
                            crashWarning = `üö® MAJOR ${crashType} CRASH DETECTED! üö®\n`;
                            crashWarning += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                            crashWarning += `‚ö†Ô∏è This pet dropped significantly in ${crashType.toLowerCase()}!\n`;
                            crashWarning += `üìâ Total Drop: ${crashAmount.toFixed(2)}\n`;
                            crashWarning += `‚ùå NO RECOVERY YET - AVOID TRADING!\n\n`;
                        }
                    }
                }
            } catch (histErr) {
                console.error("History check failed for", p.n, histErr);
            }
        }
        
        const generateSentence = (str, label) => {
            if (!str || typeof str !== 'string' || str.trim() === "") return null;
            let parts = str.trim().split(' ');
            if (parts.length < 2) return null;
            
            let icon = parts[0]; 
            let sentences = [];
            for (let i = 1; i < parts.length; i++) {
                let segment = parts[i];
                if (!segment.includes(':')) continue;
                let [tierKey, val] = segment.split(':');
                let tierName = (tierKey === 'Ne' ? 'Neon' : (tierKey === 'M' ? 'Mega' : 'Normal'));
                let actionWord = val.includes('+') ? 'INCREASED' : 'DECREASED';
                let amount = val.replace(/[+-]/g, "").replace(/[VD]$/g, "");
                sentences.push(`‚Ä¢ ${tierName} ${p.n} ${label} ${actionWord} BY ${amount}`);
            }
            return { icon, text: sentences.join('\n') };
        };
        
        // FIXED: Trend icons show ONLY their trend data (no crash warning)
        const vData = generateSentence(p.vt, "Value");
        if (vData) html += `<span title="${vData.text}" style="margin-left:4px; cursor:help; font-size:1.2em; filter: drop-shadow(0 0 2px #fff);">${vData.icon}</span>`;
        
        const dData = generateSentence(p.dt, "Demand");
        if (dData) html += `<span title="${dData.text}" style="margin-left:4px; cursor:help; font-size:1.2em; filter: drop-shadow(0 0 2px #fff);">${dData.icon}</span>`;
        
        // FIXED: Crash siren shows ONLY crash warning (separate from trend icons)
        if (crashWarning) {
            console.log(`‚úÖ Adding crash siren for ${p.n}`);
            html += `<span title="${crashWarning}" style="margin-left:4px; cursor:help; font-size:1.4em; color:#ef4444; filter: drop-shadow(0 0 4px #ef4444); animation: pulse 2s infinite;">üö®</span>`;
        }
        
    } catch (err) { 
        console.error("getTrendIcons error:", err);
        return ""; 
    }
    return html;
}
        async function fetchHistory() {
    if (HISTORY_DATA.length > 0) {
        console.log("üì¶ History already loaded:", HISTORY_DATA.length, "records");
        return;
    }
    
    try {
        console.log("üîÑ Fetching history from:", HISTORY_CSV_URL);
        const response = await fetch(HISTORY_CSV_URL + "&t=" + Date.now());
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const text = await response.text();
        console.log("üìÑ Raw CSV received, length:", text.length);
        
        const lines = text.trim().split('\n');
        console.log("üìä Total lines in CSV:", lines.length);
        
        if (lines.length < 2) {
            console.warn("‚ö†Ô∏è No history data rows (only header or empty)");
            return;
        }
        
        // Get headers to map columns correctly
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        console.log("üìä Headers:", headers);
        
        // Parse with ALL columns preserved
        HISTORY_DATA = lines.slice(1).map((line, index) => {
            const vals = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const row = {};
            
            headers.forEach((header, i) => {
                const val = vals[i]?.trim() || '';
                // Convert numbers, keep strings as-is
                row[header] = (!isNaN(parseFloat(val)) && isFinite(val) && val !== '') 
                    ? parseFloat(val) 
                    : val;
            });
            
            // Log first row for debugging
            if (index === 0) {
                console.log("üìä Sample row:", row);
            }
            
            return row;
        }).filter(row => row.name || row['pet name']); // Support both column names
        
        console.log("‚úÖ History loaded successfully:", HISTORY_DATA.length, "records");
        
    } catch (e) { 
        console.error("‚ùå History fetch failed:", e);
        HISTORY_DATA = [];
    }
}
        function closeGraph() { document.getElementById('graphOverlay').style.display = 'none'; }
        async function openGraph(petData) {
    await fetchHistory();
    
    // Extract name and type from the petData object
    const name = petData.n;
    const type = petData.type || 'reg';
    const isFly = petData.f_st || false;
    const isRide = petData.r_st || false;
    
    // Determine which columns to use based on type and potions
    // Determine which columns to use based ONLY on type (Neon/Mega/Normal)
    // Ignore Fly/Ride variants - always use base version
    let demandKey = 'd';
    let valueKey = 'v';
    
    if (type === 'neon') {
        demandKey = 'nd';
        valueKey = 'n_v';
    } else if (type === 'mega') {
        demandKey = 'md';
        valueKey = 'm_v';
    } else {
        // Normal (base version, no fly/ride)
        demandKey = 'd';
        valueKey = 'v';
    }
    
    // Filter history for this specific pet (case insensitive)
    const petHistory = HISTORY_DATA.filter(p => {
        const histName = (p.name || p['pet name'] || '').toLowerCase().trim();
        return histName === name.toLowerCase().trim();
    });
    
    if (petHistory.length < 2) {
        alert(`Not enough historical data for ${name}.\n\nFound ${petHistory.length} record(s).`);
        return;
    }
    
    // Create title with version info
    // Create title with version info (ONLY Neon/Mega/Normal - ignore Fly/Ride)
    let versionText = type === 'neon' ? 'NEON ' : (type === 'mega' ? 'MEGA ' : 'NORMAL ');
    
    // Override valueKey to use base values (ignore fly/ride variants)
    if (type === 'neon') {
        valueKey = 'n_v';
    } else if (type === 'mega') {
        valueKey = 'm_v';
    } else {
        valueKey = 'v';
    }
    
    document.getElementById('graphTitle').innerText = versionText + name.toUpperCase();
    document.getElementById('graphOverlay').style.display = 'flex';
    
    const ctx = document.getElementById('petChart').getContext('2d');
    if (petChart) petChart.destroy();
    
    // Extract the correct data using the determined keys
    const demandData = petHistory.map(p => p[demandKey] || p.d || 0);
    const valueData = petHistory.map(p => p[valueKey] || p.v || 0);
    
    console.log(`üìä Graphing ${name} (${versionText})`);
    console.log(`üìä Using demand key: ${demandKey}, value key: ${valueKey}`);
    console.log(`üìä Sample values - Demand: ${demandData[0]}, Value: ${valueData[0]}`);
    
    const dataPointCount = valueData.length;
    const firstValue = valueData[0];
    const lastValue = valueData[valueData.length - 1];
    const minValue = Math.min(...valueData);
    const maxValue = Math.max(...valueData);
    const firstDemand = demandData[0];
    const lastDemand = demandData[demandData.length - 1];
    const avgDemand = demandData.reduce((a, b) => a + b, 0) / demandData.length;
    const peakDemand = Math.max(...demandData);
    const lowestDemand = Math.min(...demandData);
    
    // OVERALL TREND (entire dataset)
    const overallValueChange = lastValue - firstValue;
    const overallValueChangePercent = ((overallValueChange / firstValue) * 100);
    const overallDemandChange = lastDemand - firstDemand;
    const overallDemandChangePercent = firstDemand > 0 ? ((overallDemandChange / firstDemand) * 100) : 0;
    
    // RECENT TREND (last 25% of data vs previous 75%)
    const splitPoint = Math.floor(dataPointCount * 0.75);
    const recentValues = valueData.slice(splitPoint);
    const olderValues = valueData.slice(0, splitPoint);
    const recentAvg = recentValues.reduce((a, b) => a + b, 0) / recentValues.length;
    const olderAvg = olderValues.reduce((a, b) => a + b, 0) / olderValues.length;
    const recentTrendChange = ((recentAvg - olderAvg) / olderAvg) * 100;
    
    const recentDemands = demandData.slice(splitPoint);
    const olderDemands = demandData.slice(0, splitPoint);
    const recentDemandAvg = recentDemands.reduce((a, b) => a + b, 0) / recentDemands.length;
    const olderDemandAvg = olderDemands.reduce((a, b) => a + b, 0) / olderDemands.length;
    const recentDemandTrendChange = olderDemandAvg > 0 ? ((recentDemandAvg - olderDemandAvg) / olderDemandAvg) * 100 : 0;
    
    // MOMENTUM DETECTION (is trend accelerating or decelerating?)
    let momentum = 'neutral';
    if (dataPointCount >= 6) {
        const third = Math.floor(dataPointCount / 3);
        const early = valueData.slice(0, third);
        const mid = valueData.slice(third, third * 2);
        const late = valueData.slice(third * 2);
        const earlyAvg = early.reduce((a, b) => a + b, 0) / early.length;
        const midAvg = mid.reduce((a, b) => a + b, 0) / mid.length;
        const lateAvg = late.reduce((a, b) => a + b, 0) / late.length;
        const earlySlope = midAvg - earlyAvg;
        const lateSlope = lateAvg - midAvg;
        if (Math.abs(lateSlope) > Math.abs(earlySlope) * 1.3) {
            momentum = lateSlope > 0 ? 'accelerating upward' : 'accelerating downward';
        } else if (Math.abs(lateSlope) < Math.abs(earlySlope) * 0.7) {
            momentum = 'decelerating';
        }
    }
    
    // VOLATILITY ANALYSIS
    const volatilityRange = maxValue - minValue;
    const volatilityPercent = ((volatilityRange / firstValue) * 100);
    let valueFluctuations = 0;
    let upMoves = 0;
    let downMoves = 0;
    for (let i = 1; i < valueData.length; i++) {
        const change = valueData[i] - valueData[i-1];
        valueFluctuations += Math.abs(change);
        if (change > 0) upMoves++;
        else if (change < 0) downMoves++;
    }
    const avgFluctuation = valueFluctuations / (valueData.length - 1);
    const isVolatile = volatilityPercent > 20 || avgFluctuation > firstValue * 0.05;
    const volatilityBias = upMoves > downMoves * 1.3 ? 'upward' : downMoves > upMoves * 1.3 ? 'downward' : 'neutral';
    
    // PEAK DETECTION
    const isNearPeak = lastValue >= maxValue * 0.95;
    const isNearBottom = lastValue <= minValue * 1.05;
    
    // ‚îÄ‚îÄ REAL DATE/TIME PARSING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Tries multiple common date formats from the CSV timestamps
    function parseTimestamp(raw) {
        if (!raw || typeof raw !== 'string') return null;
        const s = raw.trim();
        // Try native parse first (ISO, MM/DD/YYYY, etc.)
        let d = new Date(s);
        if (!isNaN(d)) return d;
        // Try DD/MM/YYYY
        const dmy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
        if (dmy) { d = new Date(`${dmy[3]}-${dmy[2].padStart(2,'0')}-${dmy[1].padStart(2,'0')}`); if (!isNaN(d)) return d; }
        // Try Month DD (e.g. "Jan 5" or "January 5")
        const monthDay = s.match(/^([A-Za-z]+)\s+(\d{1,2}),?\s*(\d{4})?$/);
        if (monthDay) { d = new Date(`${monthDay[1]} ${monthDay[2]} ${monthDay[3] || new Date().getFullYear()}`); if (!isNaN(d)) return d; }
        return null;
    }

    const rawTimestamps = petHistory.map(p => p.timestamp || p.time || p.date || '');
    const parsedDates   = rawTimestamps.map(parseTimestamp);
    const validDates    = parsedDates.filter(d => d !== null);
    const hasRealDates  = validDates.length >= 2;

    let totalDaysSpan     = null;
    let avgDaysBetweenPoints = null;
    let isSparseData      = false;
    let timeSpan          = 'unknown timeframe';
    let perDayValueChange = null;   // absolute value change per day
    let recentDaysWindow  = null;   // how many calendar days the "recent" slice covers

    if (hasRealDates) {
        const firstDate = validDates[0];
        const lastDate  = validDates[validDates.length - 1];
        const MS_PER_DAY = 86400000;
        totalDaysSpan = Math.round((lastDate - firstDate) / MS_PER_DAY);
        avgDaysBetweenPoints = dataPointCount > 1 ? totalDaysSpan / (dataPointCount - 1) : 0;
        isSparseData = avgDaysBetweenPoints > 14; // more than 2 weeks between updates = sparse

        // Per-day rate of value change
        if (totalDaysSpan > 0) {
            perDayValueChange = overallValueChange / totalDaysSpan;
        }

        // How many days does the "recent" slice cover?
        const splitDateIdx = Math.floor(validDates.length * 0.75);
        if (splitDateIdx < validDates.length) {
            recentDaysWindow = Math.round((lastDate - validDates[splitDateIdx]) / MS_PER_DAY);
        }

        // Human-readable span
        if (totalDaysSpan < 7) timeSpan = `past ${totalDaysSpan} day${totalDaysSpan !== 1 ? 's' : ''}`;
        else if (totalDaysSpan < 30) timeSpan = `past ${Math.round(totalDaysSpan / 7)} week${Math.round(totalDaysSpan / 7) !== 1 ? 's' : ''}`;
        else if (totalDaysSpan < 365) timeSpan = `past ${Math.round(totalDaysSpan / 30)} month${Math.round(totalDaysSpan / 30) !== 1 ? 's' : ''}`;
        else timeSpan = `past ${(totalDaysSpan / 365).toFixed(1)} year${totalDaysSpan > 500 ? 's' : ''}`;
    } else {
        // No parseable dates ‚Äî fall back to point-count language
        timeSpan = `across ${dataPointCount} recorded update${dataPointCount !== 1 ? 's' : ''}`;
    }

    // CONFIDENCE SCORE ‚Äî now based on days & density, not just count
    let confidence = 'LOW';
    let confidenceNote = '';
    if (hasRealDates) {
        if (totalDaysSpan >= 60 && dataPointCount >= 8 && !isSparseData) {
            confidence = 'HIGH';
            confidenceNote = `${dataPointCount} points over ${totalDaysSpan} days`;
        } else if (totalDaysSpan >= 21 && dataPointCount >= 5) {
            confidence = 'MEDIUM';
            confidenceNote = `${dataPointCount} points over ${totalDaysSpan} days`;
            if (isSparseData) confidenceNote += ' (sparse ‚Äî avg ' + Math.round(avgDaysBetweenPoints) + 'd between updates)';
        } else {
            confidence = 'LOW';
            confidenceNote = `only ${totalDaysSpan} days of data`;
            if (isSparseData) confidenceNote += ', sparsely recorded';
        }
    } else {
        if (dataPointCount >= 20) confidence = 'MEDIUM';
        confidenceNote = `${dataPointCount} data point${dataPointCount !== 1 ? 's' : ''}, no parseable timestamps`;
    }
    
    // BUILD TREND TEXT (date-aware)
    let trendText = '';

    let overallDirection = overallValueChangePercent > 10 ? 'Strong upward' :
                          overallValueChangePercent > 5  ? 'Moderate upward' :
                          overallValueChangePercent > 2  ? 'Slight upward' :
                          overallValueChangePercent < -10? 'Sharp downward' :
                          overallValueChangePercent < -5 ? 'Moderate downward' :
                          overallValueChangePercent < -2 ? 'Slight downward' : 'Stable';

    trendText = `<strong>${overallDirection}</strong> overall trend (${timeSpan}): ${firstValue.toFixed(2)} ‚Üí ${lastValue.toFixed(2)} (<span style="color: ${overallValueChangePercent >= 0 ? 'var(--win)' : 'var(--lose)'};">${overallValueChangePercent > 0 ? '+' : ''}${overallValueChangePercent.toFixed(1)}%</span>). `;

    // Show per-day rate of change if we have real dates
    if (perDayValueChange !== null && totalDaysSpan > 3) {
        const pdSign = perDayValueChange >= 0 ? '+' : '';
        trendText += `Rate of change: <strong style="color:${perDayValueChange >= 0 ? 'var(--win)' : 'var(--lose)'};">${pdSign}${perDayValueChange.toFixed(3)} value/day</strong>. `;
    }

    // Sparse data warning
    if (hasRealDates && isSparseData) {
        trendText += `<span style="color:var(--trap)">‚ö†Ô∏è Sparse data ‚Äî recorded roughly every ${Math.round(avgDaysBetweenPoints)} days, so short-term moves may be invisible.</span> `;
    }

    // Recent trend comparison ‚Äî only show if recent window is meaningful in days
    const recentWindowLabel = (hasRealDates && recentDaysWindow !== null)
        ? (recentDaysWindow < 7 ? `last ${recentDaysWindow}d` : `last ~${Math.round(recentDaysWindow/7)}wk`)
        : 'recent';
    if (Math.abs(recentTrendChange - overallValueChangePercent) > 5) {
        if (recentTrendChange > 0 && overallValueChangePercent < 0) {
            trendText += `<strong style="color: var(--win);">üîÑ RECOVERING (${recentWindowLabel}):</strong> Up <span style="color: var(--win);">+${recentTrendChange.toFixed(1)}%</span> despite overall decline. `;
        } else if (recentTrendChange < -5 && overallValueChangePercent > 0) {
            trendText += `<strong style="color: var(--lose);">‚ö†Ô∏è WEAKENING (${recentWindowLabel}):</strong> Down <span style="color: var(--lose);">${recentTrendChange.toFixed(1)}%</span> despite overall growth. `;
        } else if (recentTrendChange > overallValueChangePercent + 5) {
            trendText += `<strong style="color: var(--win);">üìà MOMENTUM BUILDING (${recentWindowLabel}):</strong> <span style="color: var(--win);">+${recentTrendChange.toFixed(1)}%</span> stronger than overall trend. `;
        }
    }

    // Demand analysis
    let demandStatus = lastDemand >= 8 ? 'excellent' : lastDemand >= 6 ? 'strong' : lastDemand >= 4 ? 'moderate' : lastDemand >= 2 ? 'weak' : 'very poor';
    trendText += `Demand is <strong style="color: ${getDemandColor(lastDemand)};">${demandStatus} (${lastDemand.toFixed(1)})</strong>`;
    if (Math.abs(overallDemandChangePercent) > 10) {
        trendText += `, ${overallDemandChangePercent > 0 ? 'up' : 'down'} ${Math.abs(overallDemandChangePercent).toFixed(1)}% from ${firstDemand.toFixed(1)}`;
    }
    trendText += '. ';

    // Peak/bottom ‚Äî only assert if data covers enough days
    const enoughDaysForPeak = !hasRealDates ? (dataPointCount >= 10) : (totalDaysSpan >= 30);
    if (isNearPeak && enoughDaysForPeak) {
        trendText += `<strong style="color: var(--trap);">‚ö†Ô∏è Near recorded high</strong> (${lastValue.toFixed(2)} vs peak ${maxValue.toFixed(2)} over ${timeSpan}). `;
    } else if (isNearPeak) {
        trendText += `Currently at the top of its <em>recent</em> range ‚Äî not enough history to call this an all-time high. `;
    }
    if (isNearBottom && enoughDaysForPeak) {
        trendText += `<strong>Near recorded low</strong> (${lastValue.toFixed(2)} vs bottom ${minValue.toFixed(2)} over ${timeSpan}). `;
    } else if (isNearBottom) {
        trendText += `At the bottom of its recent recorded range. `;
    }

    // Volatility
    if (isVolatile) {
        trendText += `<strong style="color: var(--trap);">High volatility</strong> (${volatilityPercent.toFixed(1)}% swing${hasRealDates ? ' over ' + timeSpan : ''}) with ${volatilityBias} bias. `;
    }

    // Momentum
    if (momentum !== 'neutral') {
        trendText += `Trend is <strong>${momentum}</strong>. `;
    }
    
    // ===================================================
    // Feature 7: Overhauled Trend Analysis & Recommendations
    // Uses real date/day calculations where available
    // ===================================================
    let recommendation = '';
    let recommendColor = 'white';

    const catStr     = (petData.cat || '').toLowerCase();
    const isHighTier = catStr.includes('high tier') || catStr.includes('preppy') || catStr.includes('exotic');
    const isRandom   = catStr.includes('random') || catStr.includes('common') || catStr.includes('uncommon');

    // Noise threshold ‚Äî scale based on actual days if available
    const noiseValPct  = hasRealDates && totalDaysSpan < 14 ? 5 : 3;
    const isSmallFluctuation = Math.abs(overallValueChangePercent) < noiseValPct && Math.abs(overallDemandChange) < 0.5;

    // Genuine peak/low requires meaningful time coverage
    const enoughHistory      = hasRealDates ? totalDaysSpan >= 30 : dataPointCount >= 10;
    const genuineHistoricalHigh = enoughHistory && isNearPeak;
    const genuineHistoricalLow  = enoughHistory && isNearBottom;

    // Limited data: less than 5 points OR less than 7 days if we have dates
    const limitedData = hasRealDates ? (totalDaysSpan < 7 || dataPointCount < 3) : dataPointCount < 5;

    // "Strong" trend requires meaningful time to confirm ‚Äî a 10% move in 2 days is less reliable than over 2 weeks
    const sustainedUptrend  = overallValueChangePercent > 10 && recentTrendChange > 5
                              && (!hasRealDates || totalDaysSpan >= 14);
    const sustainedDowntrend = overallValueChangePercent < -8 && recentTrendChange < -3
                              && (!hasRealDates || totalDaysSpan >= 14);

    if (limitedData) {
        // Not enough data ‚Äî don't make dramatic claims
        if (lastDemand >= 7) {
            recommendation = 'üìä Limited data ‚Äî not enough history for confident analysis. Demand looks solid right now.';
            recommendColor = 'var(--subtext)';
        } else if (lastDemand >= 4) {
            recommendation = 'üìä Limited data ‚Äî only ' + dataPointCount + ' point(s) available. Current demand is average. Trade carefully.';
            recommendColor = 'var(--subtext)';
        } else {
            recommendation = 'üìä Limited data with low demand. Insufficient history to judge trend ‚Äî approach with caution.';
            recommendColor = 'var(--trap)';
        }
    } else if (isSmallFluctuation) {
        // Minor noise, don't over-react
        if (lastDemand >= 7) {
            recommendation = '‚úÖ Short-term fluctuation in a high-demand pet ‚Äî long-term stable. Good time to trade for or hold.';
            recommendColor = 'var(--win)';
        } else if (lastDemand >= 4) {
            recommendation = '‚û°Ô∏è Minor noise ‚Äî value and demand are essentially flat. Neutral outlook; neither rush to trade nor avoid.';
            recommendColor = 'white';
        } else {
            recommendation = '‚ö†Ô∏è Stable but weak demand. Low trading velocity ‚Äî consider whether you can move this pet before acquiring.';
            recommendColor = 'var(--trap)';
        }
    } else if (genuineHistoricalHigh) {
        // Confirmed near peak across many data points
        if (isHighTier && lastDemand >= 7 && momentum === 'accelerating upward') {
            recommendation = '‚ö†Ô∏è High-Tier pet at confirmed multi-week peak with strong demand. Could continue rising, but risk of correction is real. Advanced traders only ‚Äî consider holding rather than trading away.';
            recommendColor = 'var(--trap)';
        } else if (isHighTier) {
            recommendation = '‚ö†Ô∏è High-Tier pet at genuine historical high (' + dataPointCount + ' data points). Consider holding rather than trading away ‚Äî re-entry after a dip may be costly.';
            recommendColor = 'var(--trap)';
        } else {
            recommendation = '‚ö†Ô∏è At confirmed historical high. High risk of pullback. Wait for a dip before acquiring.';
            recommendColor = 'var(--trap)';
        }
    } else if (genuineHistoricalLow) {
        // Confirmed near bottom
        if (lastDemand >= 5 && recentTrendChange > 0) {
            recommendation = '‚úÖ Short-term dip, long-term stable ‚Äî this is a reasonable time to trade for. Demand is healthy and recent trend is recovering.';
            recommendColor = 'var(--win)';
        } else if (lastDemand >= 5) {
            recommendation = '‚ö†Ô∏è Near confirmed historical low. Demand is ok, but value has not started recovering yet ‚Äî wait 1‚Äì2 more data cycles for confirmation.';
            recommendColor = 'var(--trap)';
        } else {
            recommendation = '‚ùå Near historical low with weak demand. Both value and interest are depressed ‚Äî avoid until signs of recovery.';
            recommendColor = 'var(--lose)';
        }
    } else if (sustainedUptrend) {
        // Strong, confirmed multi-day uptrend
        const dayCtx = hasRealDates ? ` over ${totalDaysSpan} days` : '';
        if (isHighTier && lastDemand >= 7) {
            recommendation = `üî• Strong uptrend in a High-Tier pet${dayCtx} ‚Äî consider holding rather than trading away. If acquiring, excellent long-term pick.`;
            recommendColor = 'var(--win)';
        } else if (lastDemand >= 6) {
            recommendation = `üî• Sustained uptrend${dayCtx} with solid demand. Good acquisition ‚Äî momentum is confirmed, not a blip.`;
            recommendColor = 'var(--win)';
        } else {
            recommendation = `‚ö†Ô∏è Value rising${dayCtx} but demand is below average. Possible value trap ‚Äî verify interest before committing.`;
            recommendColor = 'var(--trap)';
        }
    } else if (sustainedDowntrend) {
        // Confirmed sustained decline
        const dayCtx = hasRealDates ? ` over ${totalDaysSpan} days` : '';
        if (recentDemandTrendChange > 15 && lastDemand >= 6) {
            const watchTime = hasRealDates ? `${Math.max(7, Math.round(totalDaysSpan * 0.2))} more days` : '1‚Äì2 more weeks';
            recommendation = `‚ö†Ô∏è Value dropping${dayCtx} but demand recently spiked. Conflicting signals ‚Äî watch for ${watchTime} before deciding.`;
            recommendColor = 'var(--trap)';
        } else if (isHighTier) {
            recommendation = `‚ö†Ô∏è High-Tier pet in a confirmed downtrend${dayCtx}. Don't panic-trade ‚Äî these often stabilise. Wait for value to flatten.`;
            recommendColor = 'var(--trap)';
        } else {
            recommendation = `‚ùå Sustained value decline${dayCtx} with no reversal. Avoid acquiring. Trade away if you own it.`;
            recommendColor = 'var(--lose)';
        }
    } else if (overallValueChangePercent < -5 && recentTrendChange > 4) {
        // Declined overall but recently recovering
        recommendation = '‚ö†Ô∏è Short-term dip with recent recovery signals ‚Äî watch for 1 more week to confirm reversal before trading for.';
        recommendColor = 'var(--trap)';
    } else if (isVolatile) {
        if (volatilityBias === 'upward' && lastDemand >= 6) {
            recommendation = '‚ö†Ô∏è Volatile but upward-biased with decent demand. Higher risk, but real upside. Only for experienced traders.';
            recommendColor = 'var(--trap)';
        } else if (volatilityBias === 'downward') {
            recommendation = '‚ùå High volatility with downward bias. Unpredictable and risky ‚Äî avoid unless you have a specific strategy.';
            recommendColor = 'var(--lose)';
        } else {
            recommendation = '‚ö†Ô∏è Chaotic price action with no clear direction. Risky entry point ‚Äî wait for the pattern to settle.';
            recommendColor = 'var(--trap)';
        }
    } else if (lastDemand >= 7 && Math.abs(overallValueChangePercent) <= 5) {
        recommendation = '‚úÖ Stable value with strong demand ‚Äî a reliable, liquid pet. Safe to hold or trade; easy to move when needed.';
        recommendColor = 'var(--win)';
    } else if (lastDemand < 3) {
        recommendation = '‚ùå Very low demand regardless of price action. Hard to find interested traders ‚Äî poor liquidity. Avoid unless you intend to keep it.';
        recommendColor = 'var(--lose)';
    } else {
        // Fallback moderate cases
        if (overallValueChangePercent >= 3) {
            recommendation = '‚úÖ Modest, steady growth with average demand. Decent choice for patient traders; not a high-velocity pick.';
            recommendColor = 'var(--win)';
        } else if (overallValueChangePercent >= -3) {
            recommendation = '‚û°Ô∏è Value is flat with moderate demand. Neutral outlook ‚Äî fine to hold, no urgent action needed.';
            recommendColor = 'white';
        } else {
            recommendation = '‚ö†Ô∏è Slight decline in value with low-moderate demand. Not alarming, but not ideal. Monitor before committing.';
            recommendColor = 'var(--trap)';
        }
    }
    
    // Add confidence score with date context
    trendText += `<br><br><em style="color: var(--subtext); font-size: 0.85em;">Analysis confidence: <strong>${confidence}</strong> ‚Äî ${confidenceNote}</em>`;
    
    document.getElementById('trendAnalysis').innerHTML = `<strong style="color: var(--accent);">üìä Trend Analysis:</strong><br>${trendText}<br><br><strong style="color: var(--frost);">Recommendation:</strong> <span style="color: ${recommendColor};">${recommendation}</span>`;
    
    petChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: petHistory.map(p => p.timestamp || p.time || ''),
            datasets: [
                {
                    label: `Value (${versionText.trim()})`,
                    data: valueData,
                    borderColor: '#38bdf8',
                    backgroundColor: 'rgba(56, 189, 248, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.3
                },
                {
                    label: `Demand (${type === 'neon' ? 'Neon' : type === 'mega' ? 'Mega' : 'Normal'})`,
                    data: demandData,
                    borderColor: '#fbbf24',
                    backgroundColor: 'rgba(251, 191, 36, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    grid: { color: '#334155' }, 
                    ticks: { color: '#94a3b8' },
                    beginAtZero: false
                },
                x: { 
                    grid: { display: false }, 
                    ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 } 
                }
            },
            plugins: {
                legend: { 
                    labels: { color: 'white', font: { weight: 'bold', size: 14 } } 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });
}
        // CONTINUE WITH THE REST OF YOUR ORIGINAL FUNCTIONS HERE
        // (handlePetContext, openInfo, closeInfo, playSfx, pushState, undo, parseCSV, etc.)
        function handlePetContext(e, petData) {
    e.preventDefault();
    if (e.shiftKey) {
        openGraph(petData);
    } else {
        openQtyModal(petData.n);
    }
}

        function openInfo() { document.getElementById('infoOverlay').style.display = 'flex'; }
        function closeInfo() { document.getElementById('infoOverlay').style.display = 'none'; }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if (type === 'pop') {
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'win') {
                osc.type = 'triangle';
                [523, 659, 783].forEach((f, i) => osc.frequency.setValueAtTime(f, audioCtx.currentTime + (i * 0.1)));
                gain.gain.setValueAtTime(0.04, audioCtx.currentTime);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.4);
            }
        }

        function pushState() {
            if (history.length > 50) history.shift();
            history.push(JSON.stringify({ A: state.A, B: state.B, inv: state.inv }));
        }

        function undo() {
            if (history.length === 0) return;
            const last = JSON.parse(history.pop());
            state.A = (last.A || []);
            state.B = (last.B || []);
            state.inv = (last.inv || []);
            render();
            renderInventory();
            saveTrade();
        }

        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
        });

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            return lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const obj = {};
                headers.forEach((header, i) => {
                    let val = values[i] ? values[i].trim().replace(/^"|"$/g, '') : '';
                    if (!isNaN(parseFloat(val)) && isFinite(val) && val !== '') {
                        obj[header] = parseFloat(val);
                    } else {
                        obj[header] = val;
                    }
                });
                return obj;
            });
        }

        function saveTrade() {
            const simplifiedState = {
                A: state.A.map(p => ({ n: p.n, type: p.type, f_st: p.f_st, r_st: p.r_st, uid: p.uid })),
                B: state.B.map(p => ({ n: p.n, type: p.type, f_st: p.f_st, r_st: p.r_st, uid: p.uid })),
                inv: state.inv.map(p => ({ n: p.n, type: p.type, f_st: p.f_st, r_st: p.r_st, uid: p.uid }))
            };
            localStorage.setItem('tradeData', JSON.stringify(simplifiedState));
        }

        function restoreTrade() {
            const saved = localStorage.getItem('tradeData');
            if (!saved) return;
            try {
                const parsed = JSON.parse(saved);
                const hydrate = (item) => {
                    const freshData = ALL_PETS.find(p => p.n === item.n);
                    if (!freshData) return null; 
                    return { ...freshData, ...item };
                };
                state.A = (parsed.A || []).map(hydrate).filter(x => x);
                state.B = (parsed.B || []).map(hydrate).filter(x => x);
                state.inv = (parsed.inv || []).map(hydrate).filter(x => x);
                render();
            } catch (e) {
                console.error("Failed to restore trade", e);
            }
        }

        async function loadPetData() {
            try {
                const response = await fetch(MASTER_CSV_URL + "&t=" + Date.now());
                const csvText = await response.text();
                const data = parseCSV(csvText);
                
                ALL_PETS = data.map(row => ({
                    n: row.n || row.name || '',
                    d: row.d || 0,
                    nd: row.nd || 0,
                    md: row.md || 0,
                    f: row.f || 0,
                    v: row.v || 0,
                    f_v: row.f_v || 0,
                    r_v: row.r_v || 0,
                    fr_v: row.fr_v || 0,
                    n_v: row.n_v || 0,
                    n_f_v: row.n_f_v || 0, 
                    n_r_v: row.n_r_v || 0, 
                    nfr_v: row.nfr_v || 0,
                    m_v: row.m_v || 0,
                    m_f_v: row.m_f_v || 0, 
                    m_r_v: row.m_r_v || 0, 
                    mfr_v: row.mfr_v || 0,
                    nfr_f: row.nfr_f || 0,
                    mfr_f: row.mfr_f || 0,
                    cat: (row.categories || row.rarity || '').toLowerCase(),
                    vt: row['value trend'] || row['vt'] || '', 
                    dt: row['demand trend'] || row['dt'] || ''
                })).filter(p => p.n && p.n.length > 0);
                
                document.getElementById('loadingScreen').style.display = 'none';
                fetchHistory(); 
                restoreTrade();
                render();
            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.loading-text').textContent = 'Error loading data.';
            }
        }

        function openSearch(side) {
            state.target = side;
            document.getElementById('searchOverlay').classList.add('open');
            searchState.renderLimit = 50;
            filterAndRender(document.getElementById('mainSearch').value.toLowerCase());
            setTimeout(() => document.getElementById('mainSearch').focus(), 50);
        }

        function closeSearch() { document.getElementById('searchOverlay').classList.remove('open'); }

        function updateFilter() {
            searchState.sortMode = document.getElementById('sortSelect').value;
            searchState.rarityFilter = document.getElementById('rarityFilter').value.toLowerCase();
            searchState.renderLimit = 50; 
            filterAndRender(document.getElementById('mainSearch').value.toLowerCase());
        }

        document.getElementById('mainSearch').addEventListener('input', (e) => {
            searchState.renderLimit = 50; 
            filterAndRender(e.target.value.toLowerCase());
        });

        document.getElementById('searchResults').addEventListener('scroll', () => {
            const box = document.getElementById('searchResults');
            if (box.scrollTop + box.clientHeight >= box.scrollHeight - 50) {
                if (searchState.renderLimit < searchState.currentMatches.length) {
                    searchState.renderLimit += 50;
                    renderDOM(); 
                }
            }
        });

        function filterAndRender(query) {
            let matches = query === "" ? [...ALL_PETS] : ALL_PETS.filter(p => p.n.toLowerCase().includes(query));
            if (searchState.rarityFilter !== 'none') {
                matches = matches.filter(p => (p.cat || "").toLowerCase().includes(searchState.rarityFilter));
            }
            const mode = searchState.sortMode;
            if (mode !== 'default') {
                matches.sort((a, b) => {
                    if (mode === 'valHigh') return (state.mode === 'frost' ? b.f : b.v) - (state.mode === 'frost' ? a.f : a.v);
                    if (mode === 'valLow') return (state.mode === 'frost' ? a.f : a.v) - (state.mode === 'frost' ? b.f : b.v);
                    if (mode === 'demHigh') return b.d - a.d;
                    if (mode === 'demLow') return a.d - b.d;
                    return 0;
                });
            } else {
                // Feature 6: Smart sort by demand ‚Üí recent trend ‚Üí category
                matches = smartSortPets(matches, query);
            }
            searchState.currentMatches = matches;
            renderDOM();
        }

        function renderDOM() {
            const chunk = searchState.currentMatches.slice(0, searchState.renderLimit);
            const query = document.getElementById('mainSearch').value.toLowerCase();
            const resultsEl = document.getElementById('searchResults');

            // Feature 6: Trending Now section injected above the grid
            const trendingOuter = resultsEl.parentNode.querySelector('.trending-section-outer');
            if (query === '' && searchState.sortMode === 'default' && searchState.rarityFilter === 'none') {
                const trendingPets = getTrendingPets(5);
                if (trendingPets.length > 0) {
                    const pills = trendingPets.map(p => {
                        const icon = (p.dt && p.dt.includes('üî•')) ? 'üî•' : 'üìà';
                        return `<div class="trending-pill" onclick="addItem(null,'${p.n.replace(/'/g,"\\'")}',1)">${icon} ${p.n} <span style="opacity:0.6">¬∑ ${p.d}</span></div>`;
                    }).join('');
                    if (!trendingOuter) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'trending-section-outer';
                        wrapper.innerHTML = `<div class="trending-section"><div class="trending-title">‚ö° Trending Now</div><div class="trending-pills">${pills}</div></div>`;
                        resultsEl.parentNode.insertBefore(wrapper, resultsEl);
                    } else {
                        trendingOuter.querySelector('.trending-pills').innerHTML = pills;
                    }
                }
            } else {
                if (trendingOuter) trendingOuter.remove();
            }

            resultsEl.innerHTML = chunk.map(p => {
                const imgUrl = `https://amvgg.com/items/${encodeURIComponent(p.n)}.webp`;
                const val = state.mode === 'frost' ? p.f : p.v; 
                const rarityColor = getRarityColor(p.cat);
                const demandColor = getDemandColor(p.d);
                return `
                <div class="search-item-card" 
                     onclick="addItem(this, '${p.n.replace(/'/g, "\\'")}', 1)" 
                     oncontextmenu="handlePetContext(event, ${JSON.stringify(p).replace(/"/g, '&quot;')})"
                     style="border-color: ${rarityColor}">
                    <div class="search-item-name">${p.n}${getTrendIcons(p)}</div>
                    <img src="${imgUrl}" class="search-item-img" onerror="this.src='https://amvgg.com/items/theme-color.webp'">
                    <div class="search-item-val">${val ? val.toFixed(2) : 0}</div>
                    <div class="search-item-demand" style="color: ${demandColor}">Dem: ${p.d}</div>
                </div>`;
            }).join('');
        }

        function openQtyModal(name) {
            selectedPetForQty = name;
            document.getElementById('qtyTitle').innerText = `How many ${name}?`;
            document.getElementById('qtyInput').value = 1;
            document.getElementById('qtyModal').style.display = 'flex';
            setTimeout(() => document.getElementById('qtyInput').focus(), 50);
        }

        function closeQtyModal() {
            document.getElementById('qtyModal').style.display = 'none';
            selectedPetForQty = null;
        }

        function confirmQty() {
            const count = parseInt(document.getElementById('qtyInput').value);
            if (count > 0 && selectedPetForQty) {
                addItem(null, selectedPetForQty, count);
            }
            closeQtyModal();
        }

        function addItem(element, name, quantity = 1) {
            if (state.target !== 'inv' && state.target !== 'dream') {
                if ((state[state.target] ? state[state.target].length : 0) + quantity > 18) {
                    alert("Trade limit reached! Adopt Me only allows 18 items per trade.");
                    return;
                }
            }
            const pet = ALL_PETS.find(x => x.n === name);
            if (!pet) return;
            pushState();
            for (let i = 0; i < quantity; i++) {
                const newPet = { ...pet, uid: Math.random(), type: 'reg', f_st: false, r_st: false };
                if (state.target === 'inv') { state.inv.push(newPet); } 
                else if (state.target === 'dream') { state.dreamPet = newPet; } 
                else { state[state.target].push(newPet); }
            }
            if (state.target === 'inv') {
                renderInventory();
                if (element) {
                    element.classList.add('added');
                    setTimeout(() => element.classList.remove('added'), 500);
                }
            } else if (state.target === 'dream') {
                renderInventory();
                closeSearch();
            } else {
                render();
                closeSearch(); 
            }
            playSfx('pop'); saveTrade(); 
        }

        function duplicate(s, uid) {
            if (state[s].length >= 18 && s !== 'inv') return;
            pushState();
            const original = state[s].find(x => x.uid === uid);
            if (!original) return;
            const copy = { ...original, uid: Math.random() };
            state[s].push(copy);
            if (s === 'inv') renderInventory(); else render();
            playSfx('pop'); saveTrade(); 
        }

        function remove(s, uid) { 
            pushState();
            state[s] = state[s].filter(x => x.uid !== uid); 
            if (s === 'inv') renderInventory(); else render();
            saveTrade(); 
        }

        function openInventory() { document.getElementById('invOverlay').style.display = 'flex'; renderInventory(); }
        function closeInventory() { document.getElementById('invOverlay').style.display = 'none'; }

        function exportInv() {
            const data = JSON.stringify(state.inv);
            const encoded = btoa(unescape(encodeURIComponent(data))); 
            navigator.clipboard.writeText(encoded).then(() => {
                alert("Inventory code copied to clipboard!");
            });
        }

        function importInv() {
            const code = prompt("Paste your inventory code here:");
            if (!code) return;
            try {
                const decoded = decodeURIComponent(escape(atob(code)));
                const data = JSON.parse(decoded);
                const validData = data.filter(item => ALL_PETS.some(p => p.n === item.n));
                if (validData.length > 0) {
                    pushState();
                    state.inv = validData.map(item => ({...item, uid: Math.random()}));
                    renderInventory();
                    alert(`Successfully imported ${validData.length} items!`);
                    saveTrade();
                } else {
                    alert("Invalid data found. No items imported.");
                }
            } catch (e) {
                console.error(e);
                alert("Error importing data. Code might be invalid.");
            }
        }

        function openAnalytics() {
            const overlay = document.getElementById('analyticsOverlay');
            const body = document.getElementById('analyticsBody');
            overlay.style.display = 'flex';
            const rarities = {};
            const categories = {};
            let total = state.inv.length;
            if (total === 0) {
                body.innerHTML = '<div style="text-align:center; color:#94a3b8;">Inventory is empty. Add pets to see analytics.</div>';
                return;
            }
            state.inv.forEach(p => {
                const r = (p.cat || 'unknown').toLowerCase();
                let rKey = 'Common';
                if(r.includes('legendary')) rKey = 'Legendary';
                else if(r.includes('ultra')) rKey = 'Ultra-Rare';
                else if(r.includes('rare')) rKey = 'Rare';
                else if(r.includes('uncommon')) rKey = 'Uncommon';
                rarities[rKey] = (rarities[rKey] || 0) + 1;
                let cKey = 'Randoms';
                if(r.includes('preppy')) cKey = 'Preppy';
                else if(r.includes('high tier')) cKey = 'High Tier';
                else if(r.includes('exotic')) cKey = 'Exotic';
                else if(r.includes('classy')) cKey = 'Classy';
                categories[cKey] = (categories[cKey] || 0) + 1;
            });
            const generateBars = (data, colorMap) => {
                return Object.entries(data)
                    .sort((a,b) => b[1] - a[1])
                    .map(([key, count]) => {
                        const pct = ((count / total) * 100).toFixed(1);
                        const color = colorMap[key] || '#6366f1'; 
                        return `<div class="bar-row"><div class="bar-label">${key}</div><div class="bar-track"><div class="bar-fill" style="width: ${pct}%; background: ${color};"></div></div><div class="bar-stat">${count} (${pct}%)</div></div>`;
                    }).join('');
            };
            const rColors = { 'Legendary': 'var(--rarity-legendary)', 'Ultra-Rare': 'var(--rarity-ultra)', 'Rare': 'var(--rarity-rare)', 'Uncommon': 'var(--rarity-uncommon)', 'Common': 'var(--rarity-common)' };
            const cColors = { 'High Tier': '#a855f7', 'Preppy': '#ec4899', 'Exotic': '#06b6d4', 'Classy': '#f59e0b', 'Randoms': '#64748b' };
            body.innerHTML = `<div class="analytics-section"><h4>Rarity Breakdown</h4>${generateBars(rarities, rColors)}</div><div class="analytics-section"><h4>Category Breakdown</h4>${generateBars(categories, cColors)}</div>`;
        }

        function closeAnalytics() { document.getElementById('analyticsOverlay').style.display = 'none'; }
        function openHistory() { document.getElementById('historyOverlay').style.display = 'flex'; renderHistoryLog(); }
        function closeHistory() { document.getElementById('historyOverlay').style.display = 'none'; }
        
        function logCurrentTrade() {
            if (state.A.length === 0 && state.B.length === 0) return;
            if (tradeLog.length >= 10) tradeLog.shift();
            const snapshot = {
                timestamp: new Date().toLocaleTimeString(),
                A: JSON.parse(JSON.stringify(state.A)),
                B: JSON.parse(JSON.stringify(state.B)),
                verdict: document.getElementById('verdict').innerText
            };
            tradeLog.push(snapshot);
            alert("Trade Saved to History!");
        }

        function restoreFromLog(index) {
            const entry = tradeLog[index];
            if (!entry) return;
            state.A = JSON.parse(JSON.stringify(entry.A));
            state.B = JSON.parse(JSON.stringify(entry.B));
            closeHistory();
            render();
            playSfx('pop');
        }

        function renderHistoryLog() {
            const list = document.getElementById('historyList');
            if (tradeLog.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--subtext);">No history yet. Calculate trades to save them!</div>';
                return;
            }
            list.innerHTML = tradeLog.slice().reverse().map((entry, idx) => {
                const originalIdx = tradeLog.length - 1 - idx;
                return `<div class="history-item" onclick="restoreFromLog(${originalIdx})"><div class="history-time">${entry.timestamp}</div><div class="history-details"><span>${entry.A.length} Items vs ${entry.B.length} Items</span><span style="color: ${entry.verdict.includes('WIN') ? 'var(--win)' : (entry.verdict.includes('LOSE') ? 'var(--lose)' : 'white')}">${entry.verdict}</span></div></div>`;
            }).join('');
        }

        function calculatePetVal(p, mode) {
            let val = 0;
            if (mode === 'frost') {
                if (p.type === 'neon') val = p.nfr_f || (p.f * 3);
                else if (p.type === 'mega') val = p.mfr_f || (p.f * 12);
                else val = p.f;
                if (p.f_st) val += 0.01; if (p.r_st) val += 0.01;
            } else {
                if (p.type === 'neon') {
                    if (p.f_st && p.r_st) val = p.nfr_v; 
                    else if (p.f_st) val = p.n_f_v; else if (p.r_st) val = p.n_r_v; else val = p.n_v;                    
                } else if (p.type === 'mega') {
                    if (p.f_st && p.r_st) val = p.mfr_v; 
                    else if (p.f_st) val = p.m_f_v; else if (p.r_st) val = p.m_r_v; else val = p.m_v;                    
                } else {
                    if (p.f_st && p.r_st) val = p.fr_v;  
                    else if (p.f_st) val = p.f_v; else if (p.r_st) val = p.r_v; else val = p.v;                      
                }
            }
            return val;
        }

        function renderInventory() {
            const list = state.inv;
            const grid = document.getElementById('invGrid');
            grid.innerHTML = '';
            let totalV = 0, totalD = 0;
            const groups = {};
            list.forEach(p => {
                const key = `${p.n}|${p.type}|${p.f_st}|${p.r_st}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(p);
                totalV += calculatePetVal(p, 'value');
                totalD += p.type === 'neon' ? (p.nd || p.d) : (p.type === 'mega' ? (p.md || p.d) : p.d);
            });
            Object.entries(groups).forEach(([key, stack]) => {
                const p = stack[0], count = stack.length;
                const currentDemand = p.type === 'neon' ? (p.nd || p.d) : (p.type === 'mega' ? (p.md || p.d) : p.d);
                const valTotal = calculatePetVal(p, 'value') * count;
                const stackUidsString = JSON.stringify(stack.map(item => item.uid));
                const rarityColor = getRarityColor(p.cat);
                const demandColor = getDemandColor(currentDemand);
                grid.innerHTML += `
                    <div class="card" style="border-color: ${rarityColor}">
                        ${count > 1 ? `<div class="card-stack-badge">x${count}</div>` : ''}
                        <div class="del" onclick="removeStack('inv', ${stackUidsString})">‚úï</div>
                        <div style="position: absolute; top: 5px; right: 28px; background: var(--panel); border-radius: 5px; padding: 2px 4px; font-size: 10px; cursor: pointer; border: 1px solid var(--border); z-index: 12;" onclick="findSimilarToPet(${valTotal})">üîç</div>
                        <div class="card-img-container" 
                             oncontextmenu="handlePetContext(event, ${JSON.stringify(p).replace(/"/g, '&quot;')})"
                             ondblclick="duplicate('inv', ${p.uid})" title="Right click for Qty | Shift + Right click for Graph">
                             <img src="https://amvgg.com/items/${encodeURIComponent(p.n)}.webp">
                        </div>
                        <div class="card-name">${p.n}${getTrendIcons(p)}</div>
                        <div class="card-val">${valTotal.toFixed(2)}</div>
                        <div class="card-demand" style="color: ${demandColor}">Dem: ${currentDemand}</div>
                        <div class="toggles">
                            <div class="t-btn ${p.type==='neon'?'active':''}" onclick="togStack('inv',${stackUidsString},'n')">N</div>
                            <div class="t-btn ${p.type==='mega'?'active':''}" onclick="togStack('inv',${stackUidsString},'m')">M</div>
                            <div class="t-btn ${p.f_st?'active':''}" onclick="togStack('inv',${stackUidsString},'f')">F</div>
                            <div class="t-btn ${p.r_st?'active':''}" onclick="togStack('inv',${stackUidsString},'r')">R</div>
                        </div>
                    </div>`;
            });
            const finalVal = totalV.toFixed(2);
            document.getElementById('invTotalValue').innerText = finalVal;
            document.getElementById('invAvgDemand').innerText = list.length > 0 ? (totalD / list.length).toFixed(1) : "0.0";
            const v = parseFloat(finalVal);
            document.getElementById('mile-1').classList.toggle('active', v >= 1);
            document.getElementById('mile-2').classList.toggle('active', v >= 10);
            document.getElementById('mile-3').classList.toggle('active', v >= 50);
            document.getElementById('mile-4').classList.toggle('active', v >= 100);
            document.getElementById('mile-5').classList.toggle('active', v >= 155);
            updateAISuggestions(list);
        }

        function removeStack(s, uids) { pushState(); state[s] = state[s].filter(x => x.uid !== uids[0]); renderInventory(); saveTrade(); }
        function togStack(s, uids, type) {
            pushState(); uids.forEach(uid => {
                const p = state[s].find(x => x.uid === uid);
                if (!p) return;
                if (type === 'n') p.type = p.type === 'neon' ? 'reg' : 'neon';
                else if (type === 'm') p.type = p.type === 'mega' ? 'reg' : 'mega';
                else if (type === 'f') p.f_st = !p.f_st;
                else if (type === 'r') p.r_st = !p.r_st;
            });
            saveTrade(); renderInventory();
        }

        function findSimilarToTotal() { const totalVal = parseFloat(document.getElementById('invTotalValue').innerText); showSimilarPopup(totalVal); }
        function findSimilarToPet(val) { showSimilarPopup(val); }
        function showSimilarPopup(val) {
            const overlay = document.getElementById('similarOverlay');
            const list = document.getElementById('similarList');
            overlay.style.display = 'flex';
            const matches = ALL_PETS.filter(p => p.v >= val * 0.90 && p.v <= val * 1.15).sort((a, b) => b.d - a.d).slice(0, 30);
            list.innerHTML = matches.map(p => {
                const isSelected = state.aiTargetPets.some(x => x.n === p.n);
                return `<div class="similar-item ${isSelected ? 'selected' : ''}" onclick="toggleAiTarget(this, '${p.n.replace(/'/g, "\\'")}')"><img src="https://amvgg.com/items/${encodeURIComponent(p.n)}.webp" style="width: 40px; height: 40px; object-fit: contain;"><div style="flex: 1;"><div style="font-weight: 800; font-size: 0.9em;">${p.n}</div><div style="font-size: 0.7em; color: var(--subtext);">Value: ${p.v.toFixed(2)} | Demand: ${p.d}</div></div><input type="checkbox" ${isSelected ? 'checked' : ''} style="pointer-events: none;"></div>`;
            }).join('');
        }
        function toggleAiTarget(element, name) {
            const pet = ALL_PETS.find(x => x.n === name);
            const index = state.aiTargetPets.findIndex(x => x.n === name);
            if (index > -1) state.aiTargetPets.splice(index, 1);
            else state.aiTargetPets.push(pet);
            element.classList.toggle('selected');
            element.querySelector('input').checked = !element.querySelector('input').checked;
        }
        function closeSimilarPopup() { document.getElementById('similarOverlay').style.display = 'none'; renderInventory(); }

        function setAiStrategy(mode) {
            state.aiMode = mode;
            state.aiTargetPets = []; 
            document.getElementById('aiTogNormal').classList.toggle('active', mode === 'normal');
            document.getElementById('aiTogVelocity').classList.toggle('active', mode === 'velocity');
            renderInventory();
        }

        function updateStrategyCount(val) {
            state.strategyLimit = parseInt(val);
            document.getElementById('strategyCountVal').innerText = val;
            renderInventory();
        }

        function clearDreamPet() { state.dreamPet = null; renderInventory(); }

        function updateAISuggestions(inventory) {
            const box = document.getElementById('aiSuggestions');
            const dreamContainer = document.getElementById('dreamPetContainer');
            if (state.dreamPet) {
                dreamContainer.innerHTML = `<div class="dream-active-badge"><span>Target: ${state.dreamPet.n}</span><span style="cursor: pointer;" onclick="clearDreamPet()">‚úï</span></div>`;
                const totalInvVal = parseFloat(document.getElementById('invTotalValue').innerText);
                const freshDream = ALL_PETS.find(x => x.n === state.dreamPet.n);
                const dreamVal = freshDream ? freshDream.v : state.dreamPet.v; 
                const pct = Math.min((totalInvVal / dreamVal) * 100, 100).toFixed(1);
                let suggestions = `<div class="ai-summary"><b>Dream Progress:</b> ${pct}%<div class="dream-progress-bg"><div class="dream-progress-fill" style="width: ${pct}%"></div></div></div>`;
                let bestCombos = [];
                const shuffled = [...inventory].sort(() => Math.random() - 0.5);
                for(let i=0; i<100; i++) {
                    let combo = []; let sum = 0; const attempt = shuffled.sort(() => Math.random() - 0.5); 
                    for(let p of attempt) {
                        let val = calculatePetVal(p, 'value');
                        if (sum + val <= dreamVal * 1.1) { combo.push(p); sum += val; }
                    }
                    if(combo.length > 0) { bestCombos.push({ offer: combo, sum: sum, diff: Math.abs(dreamVal - sum) }); }
                }
                bestCombos.sort((a,b) => a.diff - b.diff);
                bestCombos = bestCombos.filter((v,i,a)=>a.findIndex(t=>(t.sum===v.sum))===i).slice(0, 5);
                box.innerHTML = suggestions + bestCombos.map(r => {
                    const diffVal = (dreamVal - r.sum).toFixed(2);
                    return `<div class="ai-suggestion" style="border-left-color: var(--rarity-legendary);">Offer: ${r.offer.map(p => (p.type === 'neon' ? 'Neon ' : (p.type === 'mega' ? 'Mega ' : '')) + p.n).join(' + ')}<br><div class="ai-stats-row"><span class="ai-stat-pill" style="background:#334155; color:white;">Total: ${r.sum.toFixed(2)}</span><span class="ai-stat-pill" style="color: ${diffVal > 0 ? 'var(--lose)' : 'var(--win)'}">Remaining: ${diffVal}</span></div></div>`;
                }).join('');
                return;
            } else { dreamContainer.innerHTML = `<button class="nav-btn" style="width: 100%; font-size: 0.8em; padding: 8px;" onclick="openSearch('dream')">‚òÖ Set Dream Pet</button>`; }
            if (inventory.length === 0) { box.innerHTML = `<div class="ai-suggestion">Add pets to inventory...</div>`; return; }
            const shuffled = [...inventory].sort(() => Math.random() - 0.5);
            const totalInvVal = parseFloat(document.getElementById('invTotalValue').innerText);
            const remaining = (155.0 - totalInvVal).toFixed(1);
            let suggestions = `<div class="ai-summary"><b>Progress:</b> You are <b>${remaining} Value</b> away from a Shadow Dragon.</div>`;
            let results = [];
            let usedPetUids = new Set();
            const findTarget = (val) => {
                if (state.aiTargetPets.length > 0) return state.aiTargetPets[Math.floor(Math.random() * state.aiTargetPets.length)];
                let marginMin = state.aiMode === 'velocity' ? 0.80 : 1.01;
                let marginMax = state.aiMode === 'velocity' ? 1.10 : 1.25;
                return ALL_PETS.filter(p => p.v > val * marginMin && p.v < val * marginMax).sort((a,b) => b.d - a.d)[0];
            };
            for(let i = 0; i < 50 && results.length < state.strategyLimit; i++) {
                let bundle = []; let available = shuffled.filter(p => !usedPetUids.has(p.uid));
                if (available.length < 1) break;
                let limit = (state.aiMode === 'velocity') ? 10 : 4;
                bundle = available.slice(0, Math.min(available.length, limit));
                if (bundle.length > 0) {
                    let bundleVal = bundle.reduce((s, p) => s + calculatePetVal(p, 'value'), 0);
                    let bundleDem = (bundle.reduce((s, p) => s + p.d, 0) / bundle.length);
                    let target = findTarget(bundleVal);
                    if (target) {
                        bundle.forEach(p => usedPetUids.add(p.uid));
                        let vDiff = (target.v - bundleVal).toFixed(2);
                        let dDiff = (target.d - bundleDem).toFixed(1);
                        let winPct = ((target.v / bundleVal) - 1) * 100;
                        results.push({ offer: bundle, target: target, vDiff: vDiff, dDiff: dDiff, winPct: winPct.toFixed(1) });
                    }
                }
            }
            box.innerHTML = suggestions + results.map(r => `<div class="ai-suggestion">Offer: ${r.offer.map(p => (p.type === 'neon' ? 'Neon ' : (p.type === 'mega' ? 'Mega ' : '')) + p.n).join(' + ')}<br>Target: <span class="ai-item-tag" style="background:var(--win)">Normal ${r.target.n}</span><div class="ai-stats-row"><span class="ai-stat-pill pill-win" style="${parseFloat(r.vDiff) < 0 ? 'color:var(--lose); background:rgba(239,68,68,0.1);' : ''}">Profit: ${r.vDiff} (${r.winPct}%)</span><span class="ai-stat-pill pill-dem" style="color:${getDemandColor(parseFloat(r.dDiff) + 5)}">Demand Shift: ${r.dDiff > 0 ? '+' : ''}${r.dDiff}</span></div></div>`).join('');
        }

        function renderSide(s) {
            const list = state[s];
            const grid = document.getElementById(`grid${s}`);
            grid.innerHTML = '';
            let totalV = 0, totalD = 0;
            list.forEach(p => {
                let currentDemand = p.type === 'neon' ? (p.nd || p.d) : (p.type === 'mega' ? (p.md || p.d) : p.d);
                let val = calculatePetVal(p, state.mode);
                totalV += val; totalD += currentDemand;
                const imgUrl = `https://amvgg.com/items/${encodeURIComponent(p.n)}.webp`;
                const rarityColor = getRarityColor(p.cat);
                const demandColor = getDemandColor(currentDemand);
                grid.innerHTML += `
                    <div class="card" style="border-color: ${rarityColor}">
                        <div class="del" onclick="remove('${s}', ${p.uid})">‚úï</div>
                        <div class="card-img-container" 
                             oncontextmenu="handlePetContext(event, ${JSON.stringify(p).replace(/"/g, '&quot;')})"
                             ondblclick="duplicate('${s}', ${p.uid})" title="Right click for Qty | Shift + Right click for Graph">
                            <img src="${imgUrl}" onerror="this.src='https://amvgg.com/items/theme-color.webp'">
                        </div>
                        <div class="card-name">${p.n}${getTrendIcons(p)}</div>
                        <div class="card-val">${val.toFixed(2)}</div>
                        <div class="card-demand" style="color: ${demandColor}">Dem: ${currentDemand}</div>
                        <div class="toggles">
                            <div class="t-btn ${p.type==='neon'?'active':''}" onclick="tog('${s}',${p.uid},'n')">N</div>
                            <div class="t-btn ${p.type==='mega'?'active':''}" onclick="tog('${s}',${p.uid},'m')">M</div>
                            <div class="t-btn ${p.f_st?'active':''}" onclick="tog('${s}',${p.uid},'f')">F</div>
                            <div class="t-btn ${p.r_st?'active':''}" onclick="tog('${s}',${p.uid},'r')">R</div>
                        </div>
                    </div>`;
            });
            grid.innerHTML += `<div class="plus" onclick="openSearch('${s}')">+</div>`;
            document.getElementById(`tot${s}`).innerText = totalV.toFixed(2);
            document.getElementById(`cnt${s}`).innerText = list.length;
            document.getElementById(`dem${s}`).innerText = list.length > 0 ? (totalD / list.length).toFixed(1) : "0.0";
        }

        function calculate() {
            const vA = parseFloat(document.getElementById('totA').innerText);
            const vB = parseFloat(document.getElementById('totB').innerText);
            const demA = parseFloat(document.getElementById('demA').innerText);
            const demB = parseFloat(document.getElementById('demB').innerText);
            const verdict = document.getElementById('verdict'), vDiff = document.getElementById('vDiff'), vSub = document.getElementById('vSub');
            const gaugeNeedle = document.getElementById('gaugeNeedle');
            const gaugeBar = document.getElementById('gaugeBar');
            let isTrap = false;
            if (vA === 0 && vB === 0) { verdict.innerText = "--"; verdict.className = "v-text"; gaugeNeedle.style.left = "50%"; gaugeBar.classList.remove('trap-active'); return; }
            const diff = vB - vA, pDiff = vA > 0 ? (diff / vA) : (vB > 0 ? 1.0 : 0);
            const demGap = demA - demB;
            let needlePos = 50 + (pDiff / 0.15 * 50);
            if (needlePos < 0) needlePos = 0; if (needlePos > 100) needlePos = 100;
            gaugeNeedle.style.left = `${needlePos}%`;
            if (Math.abs(diff) < 0.01) { verdict.innerText = "FAIR"; verdict.className = "v-text fair-c"; vSub.innerText = "The trade is perfectly balanced in value. No one gain or loses raw wealth."; }
            else if (diff > 0) {
                if (demGap >= 3 && pDiff < 0.4) { verdict.innerText = "TRAP"; verdict.className = "v-text trap-c"; vSub.innerText = `DANGER: You are gaining ${diff.toFixed(2)} value, but losing ${demGap.toFixed(1)} demand points. These pets will be extremely hard to trade away later. Avoid unless you love them.`; isTrap = true; }
                else {
                    const hasSpecial = state.B.some(p => { const c = (p.cat || "").toLowerCase(); return c.includes('legendary') || c.includes('preppy') || c.includes('exotic'); });
                    if (demB > 0 && demB <= 3 && !hasSpecial && pDiff < 1.5) { verdict.innerText = "TRAP"; verdict.className = "v-text trap-c"; vSub.innerText = "VALUE BAIT: They are offering low-demand 'trash' pets. You need a much higher overpay (1.5x+) to make this even remotely fair."; isTrap = true; } 
                    else { verdict.innerText = pDiff >= 0.15 ? "BIG WIN" : "WIN"; verdict.className = "v-text win-c"; let demTxt = demB > demA ? "and you are gaining trading speed (Demand Up)!" : "but be aware you are losing a bit of trading speed."; vSub.innerText = `You are gaining ${(pDiff * 100).toFixed(1)}% in raw value ${demTxt}`; playSfx('win'); }
                }
            } else {
                verdict.innerText = pDiff <= -0.15 ? "BIG LOSE" : "LOSE"; verdict.className = "v-text lose-c";
                if (demB >= demA + 2) { vSub.innerText = `STRATEGIC OVERPAY: You lose value, but gain massive trading velocity (+${(demB - demA).toFixed(1)} Dem). This is a good move to clear stagnant pets.`; }
                else { vSub.innerText = `You are losing ${(Math.abs(pDiff) * 100).toFixed(1)}% of your value with no significant demand gain. This is a bad deal.`; }
            }
            vDiff.innerText = `Difference: ${diff > 0 ? "+" : ""}${diff.toFixed(2)} (${(pDiff * 100).toFixed(1)}%)`;
            if (isTrap) gaugeBar.classList.add('trap-active'); else gaugeBar.classList.remove('trap-active');
            updateVerdictExtras();
        }

        function render() { renderSide('A'); renderSide('B'); calculate(); updateTradeSuggestions(); }
        function setMode(m) { state.mode = m; document.getElementById('btnFrost').classList.toggle('active', m === 'frost'); document.getElementById('btnValue').classList.toggle('active', m === 'value'); render(); }
        function tog(s, uid, type) {
            pushState(); const p = state[s].find(x => x.uid === uid);
            if (!p) return;
            if (type === 'n') p.type = p.type === 'neon' ? 'reg' : 'neon';
            else if (type === 'm') p.type = p.type === 'mega' ? 'reg' : 'mega';
            else if (type === 'f') p.f_st = !p.f_st;
            else if (type === 'r') p.r_st = !p.r_st;
            saveTrade(); if (s === 'inv') renderInventory(); else render();
        }

        function updateTradeSuggestions() {
            const container = document.getElementById('sideASuggestions');
            const list = document.getElementById('suggestList');
            const targetVal = parseFloat(document.getElementById('totB').innerText);
            if (targetVal <= 0 || state.inv.length === 0) { container.style.display = 'none'; return; }
            container.style.display = 'block'; list.innerHTML = '';
            let pool = [...state.inv].sort(() => Math.random() - 0.5);
            for (let i = 0; i < 3; i++) {
                let bundle = [], sum = 0;
                for (let p of pool) {
                    let v = calculatePetVal(p, state.mode);
                    if (sum + v <= targetVal * 1.15) { bundle.push(p); sum += v; }
                    if (sum >= targetVal * 0.9) break;
                }
                if (bundle.length > 0) {
                    list.innerHTML += `<div class="suggest-pill" onclick='applySuggestion(${JSON.stringify(bundle.map(b=>b.uid))})'><div class="suggest-items-text">${bundle.map(b=>b.n).join(' + ')}</div><div class="suggest-val-text">${sum.toFixed(2)}</div></div>`;
                }
            }
        }

        function applySuggestion(uids) {
            pushState(); uids.forEach(uid => {
                const item = state.inv.find(x => x.uid === uid);
                if (item) state.A.push({...item, uid: Math.random()});
            });
            render(); saveTrade();
        }

        // ===================================================
        // NEW FEATURES ‚Äî Added on top of original code
        // ===================================================

        // Feature 1 & 2 & 3 & 4 & 5: Verdict Extras
        function getTradeSpeed(avgDemand) {
            if (avgDemand > 7)  return { label: 'Fast',     cls: 'speed-fast', emoji: '‚ö°' };
            if (avgDemand >= 4) return { label: 'Moderate', cls: 'speed-mod',  emoji: '‚è±Ô∏è' };
            return                     { label: 'Slow',     cls: 'speed-slow', emoji: 'üê¢' };
        }

        function getFlipScore(sideList) {
            if (!sideList || sideList.length === 0) return null;
            // One high-demand pet scores higher than many low-demand ones
            const avgDem = sideList.reduce((s, p) => {
                const d = p.type === 'neon' ? (p.nd || p.d) : (p.type === 'mega' ? (p.md || p.d) : p.d);
                return s + d;
            }, 0) / sideList.length;
            // Penalise for having many pets (harder to flip a stack)
            const countPenalty = Math.max(0, (sideList.length - 1) * 0.5);
            const raw = avgDem - countPenalty;
            let label, cls;
            if (raw >= 6.5) { label = 'üî• High Flip Potential'; cls = 'flip-high'; }
            else if (raw >= 4) { label = '„ÄΩÔ∏è Moderate Flip Potential'; cls = 'flip-med'; }
            else { label = 'üßä Low Flip Potential'; cls = 'flip-low'; }
            return { label, cls, raw };
        }

        function updateVerdictExtras() {
            const box = document.getElementById('verdictExtras');
            const vA = parseFloat(document.getElementById('totA').innerText) || 0;
            const vB = parseFloat(document.getElementById('totB').innerText) || 0;
            if (vA === 0 && vB === 0) { box.innerHTML = ''; return; }

            const listA = state.A, listB = state.B;
            const cntA = listA.length, cntB = listB.length;
            let html = '';

            if (cntA > 0 && cntB > 0) {
                const avgDemB = listB.reduce((s,p) => s + (p.d || 0), 0) / cntB;
                const pDiff = vA > 0 ? (vB - vA) / vA : 0; // positive = you gain value

                // --- Downgrade Detection (one-for-many only) ---
                if (cntA === 1 && cntB >= 2) {
                    if (avgDemB < 4) {
                        html += `<span class="trade-type-tag tag-downgrade">‚¨áÔ∏è DOWNGRADE ‚Äî Splitting into low-demand stack</span>`;
                    } else {
                        html += `<span class="trade-type-tag tag-downgrade">‚¨áÔ∏è DOWNGRADE ‚Äî One-for-Many</span>`;
                    }
                }

                // --- Stack Penalty (RECEIVING side only, and only if NOT a big overpay) ---
                // If they give you 3+ low-demand pets and you're not getting significantly more value, flag it.
                // But if you're giving the stack (as overpay), don't penalise ‚Äî that's expected.
                if (cntB >= 3) {
                    const avgDemReceiving = listB.reduce((s,p) => s + (p.d||0), 0) / cntB;
                    // Only warn if the value you receive is NOT a huge overpay for you
                    // i.e. you're getting a stack that's roughly even or worse in value
                    const youAreGettingStack = true; // cntB is the receiving side
                    if (avgDemReceiving < 5 && pDiff < 0.35) {
                        html += `<span class="trade-type-tag tag-penalty">‚ö†Ô∏è STACK WARNING ‚Äî Receiving ${cntB} low-demand pets that will be hard to move</span>`;
                    }
                }

                // --- Getting Played Alert (low-demand stack dump only) ---
                const lowDemReceiving = listB.filter(p => (p.d || 0) < 4).length;
                if (cntB >= 4 && lowDemReceiving >= 3 && cntB > cntA && pDiff < 0.4) {
                    html += `<span class="trade-type-tag tag-played">üö© GETTING PLAYED ‚Äî Receiving ${cntB} pets, ${lowDemReceiving} have low demand</span>`;
                }
            }

            // --- Trade Speed Estimate ---
            const rawDemA = document.getElementById('demA').innerText.replace('Avg Demand: ', '') || '0';
            const rawDemB = document.getElementById('demB').innerText.replace('Avg Demand: ', '') || '0';
            const avgDA = parseFloat(rawDemA) || 0;
            const avgDB = parseFloat(rawDemB) || 0;
            if (cntA > 0 || cntB > 0) {
                const sA = getTradeSpeed(avgDA), sB = getTradeSpeed(avgDB);
                html += `<div class="speed-row">
                    <span class="speed-pill ${sA.cls}">${sA.emoji} You Give: ${sA.label}</span>
                    <span class="speed-pill ${sB.cls}">${sB.emoji} You Receive: ${sB.label}</span>
                </div>`;
            }

            // --- Flip Potential Score (Side B = what you receive) ---
            if (cntB > 0) {
                const fp = getFlipScore(listB);
                if (fp) {
                    html += `<div class="flip-row">Flip Potential: <span class="${fp.cls}">${fp.label}</span></div>`;
                }
            }

            box.innerHTML = html;
        }

        // ===================================================
        // Feature 6: Smarter search helpers
        // ===================================================
        function getTrendingPets(limit = 5) {
            // Score by upward momentum from trend data
            return [...ALL_PETS]
                .map(p => {
                    let score = 0;
                    if (p.vt && p.vt.includes('üìà')) score += 3;
                    if (p.dt && p.dt.includes('üî•')) score += 3;
                    if (p.vt && p.vt.includes('üìâ')) score -= 2;
                    if (p.dt && p.dt.includes('‚ùÑÔ∏è')) score -= 2;
                    score += (p.d || 0) * 0.3;
                    return { p, score };
                })
                .filter(x => x.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, limit)
                .map(x => x.p);
        }

        function smartSortPets(list, query) {
            const HIGH_CATS = ['high tier', 'preppy'];
            return list.slice().sort((a, b) => {
                // 1. Demand score
                const dDiff = (b.d || 0) - (a.d || 0);
                if (Math.abs(dDiff) >= 1) return dDiff;
                // 2. Recent trend momentum
                const mA = ((a.vt||'').includes('üìà') ? 2 : 0) + ((a.dt||'').includes('üî•') ? 2 : 0);
                const mB = ((b.vt||'').includes('üìà') ? 2 : 0) + ((b.dt||'').includes('üî•') ? 2 : 0);
                if (mA !== mB) return mB - mA;
                // 3. Category preference
                const catA = HIGH_CATS.some(c => (a.cat||'').includes(c)) ? 1 : 0;
                const catB = HIGH_CATS.some(c => (b.cat||'').includes(c)) ? 1 : 0;
                if (catA !== catB) return catB - catA;
                return 0;
            });
        }

        loadPetData();
    </script>
    <div id="verdictExtras" class="verdict-extras"></div>
</body>
</html>
